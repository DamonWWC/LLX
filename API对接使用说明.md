# 林龍香大米商城 API 对接使用说明

## 📋 概述

本文档说明了如何将林龍香大米商城小程序与后端API服务进行对接。项目已经完成了完整的API对接，支持在线和离线两种模式。

## 🏗️ 架构设计

### 1. API服务层 (`utils/api.js`)
- 封装所有后端接口调用
- 统一错误处理
- 数据格式转换
- 请求超时管理

### 2. API管理器 (`utils/apiManager.js`)
- 管理本地数据与远程API的同步
- 支持离线模式
- 自动重试机制
- 数据同步队列

### 3. 数据转换器
- 本地数据格式 ↔ API数据格式
- 自动处理字段映射
- 数据类型转换

## 🔧 配置说明

### API基础配置
```javascript
// utils/api.js
const API_CONFIG = {
  baseUrl: 'http://localhost:8080', // 后端服务地址
  timeout: 10000, // 请求超时时间
  version: 'v1'
}
```

### 修改后端地址
如果需要修改后端服务地址，请更新 `utils/api.js` 中的 `API_CONFIG.baseUrl`：

```javascript
const API_CONFIG = {
  baseUrl: 'https://your-api-domain.com', // 修改为你的后端地址
  timeout: 10000,
  version: 'v1'
}
```

## 📱 功能模块

### 1. 商品管理
- ✅ 获取商品列表（优先从API获取，失败则使用本地数据）
- ✅ 创建商品（同步到API，失败则保存到本地）
- ✅ 更新商品（同步到API，失败则更新本地）
- ✅ 删除商品（同步到API，失败则删除本地）

### 2. 地址管理
- ✅ 获取地址列表（优先从API获取，失败则使用本地数据）
- ✅ 创建地址（同步到API，失败则保存到本地）
- ✅ 更新地址（同步到API，失败则更新本地）
- ✅ 删除地址（同步到API，失败则删除本地）
- ✅ 智能解析地址（优先使用API，失败则使用本地算法）

### 3. 订单管理
- ✅ 获取订单列表（优先从API获取，失败则使用本地数据）
- ✅ 创建订单（同步到API，失败则保存到本地）
- ✅ 更新订单状态（同步到API，失败则更新本地）
- ✅ 更新支付状态（同步到API，失败则更新本地）
- ✅ 计算订单（优先使用API，失败则使用本地计算）

### 4. 运费管理
- ✅ 获取运费配置（优先从API获取，失败则使用本地配置）
- ✅ 计算运费（优先使用API，失败则使用本地计算）

## 🔄 同步机制

### 1. 自动同步
- 应用启动时自动检查网络连接
- 优先从API获取最新数据
- 失败时自动降级到本地数据

### 2. 离线同步队列
- 离线操作自动加入同步队列
- 网络恢复时自动执行同步
- 支持重试机制（最多3次）

### 3. 定期同步
- 每5分钟自动尝试同步一次
- 确保数据一致性

## 🧪 测试工具

### 快速测试
```javascript
// 在页面中调用
const { runQuickTest } = require('../../utils/apiTest.js')
runQuickTest()
```

### 完整测试
```javascript
// 在页面中调用
const { runFullTest } = require('../../utils/apiTest.js')
runFullTest()
```

### 测试内容
- ✅ 系统健康检查
- ✅ 网络连接测试
- ✅ 商品API测试
- ✅ 地址API测试
- ✅ 订单API测试
- ✅ 运费API测试
- ✅ API管理器测试
- ✅ 数据同步测试

## 📊 使用示例

### 1. 获取商品列表
```javascript
// 在页面中使用
const apiManager = require('../../utils/apiManager.js')

// 获取商品列表
const products = await apiManager.productManager.getProducts()
console.log('商品列表:', products)
```

### 2. 创建商品
```javascript
// 创建新商品
const newProduct = await apiManager.productManager.createProduct({
  name: '新大米',
  price: 35.00,
  unit: '袋',
  weight: 10.00,
  image: 'data:image/svg+xml;base64,test',
  quantity: 50
})
console.log('创建的商品:', newProduct)
```

### 3. 智能解析地址
```javascript
// 解析地址
const result = await apiManager.addressManager.parseAddress(
  '张三 13800138000 广东省深圳市南山区科技园南路1号'
)
console.log('解析结果:', result)
```

## 🚨 错误处理

### 1. 网络错误
- 自动降级到本地数据
- 显示友好的错误提示
- 记录错误日志

### 2. API错误
- 统一错误处理
- 业务错误提示
- 自动重试机制

### 3. 数据错误
- 数据格式验证
- 自动修复兼容性问题
- 降级处理

## 📝 日志说明

### 日志级别
- `[API请求]` - API请求日志
- `[API响应]` - API响应日志
- `[API错误]` - API错误日志
- `[API管理器]` - API管理器日志
- `[商品管理]` - 商品管理日志
- `[地址管理]` - 地址管理日志
- `[订单管理]` - 订单管理日志
- `[API测试]` - API测试日志

### 查看日志
在微信开发者工具的控制台中查看详细日志信息。

## 🔧 故障排除

### 1. 网络连接问题
- 检查后端服务是否启动
- 确认API地址配置正确（当前配置：`http://118.126.105.146:8081`）
- 检查网络连接状态
- 运行API测试：在控制台调用 `require('./utils/apiTest.js').runAllTests()`

### 2. 地址页面不请求后端数据
- 确保API管理器已正确初始化
- 检查 `onLoad` 和 `onShow` 方法是否正确调用
- 查看控制台日志确认API调用状态
- 验证网络连接和API服务状态

### 3. 运费数据获取问题
- 已移除本地运费配置文件，全部改为API获取
- 如果API不可用，运费计算将失败
- 确保后端运费配置API正常工作
- 检查运费标准页面是否能正常加载数据

### 4. 数据同步问题
- 查看同步队列状态
- 检查本地存储数据
- 手动触发同步
- 确认 `apiManager.isOnline` 状态

### 5. 接口调用问题
- 查看API请求日志
- 检查请求参数格式
- 验证接口权限

## 📞 技术支持

如有问题，请检查：
1. 后端服务是否正常运行
2. API地址配置是否正确
3. 网络连接是否正常
4. 查看控制台错误日志

## 🎯 最佳实践

### 1. 开发建议
- 始终使用API管理器进行数据操作
- 不要直接调用API接口
- 处理异步操作的错误情况
- 提供友好的用户反馈

### 2. 性能优化
- 合理使用缓存机制
- 避免频繁的API调用
- 使用分页加载大量数据
- 优化图片和资源加载

### 3. 用户体验
- 提供加载状态提示
- 处理网络异常情况
- 支持离线操作
- 及时同步数据

---

**文档版本**: v1.0  
**最后更新**: 2025-01-22  
**维护团队**: 林龍香大米商城开发团队
