<!--index.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="top-bar">
    <view class="top-left">
      <text class="page-title">ğŸŒ¾ å¤§ç±³å•†åŸ</text>
      <text class="restore-btn" bindtap="restoreDefaultProducts">æ¢å¤é»˜è®¤</text>
    </view>
    <view class="add-product-btn" bindtap="showAddRiceDialog">
      <text class="add-icon">+</text>
      <text class="add-text">æ·»åŠ å“ç§</text>
    </view>
  </view>

  <!-- å•†å“åˆ—è¡¨ -->
  <scroll-view class="product-list" scroll-y>
    <view class="product-item" wx:for="{{riceProducts}}" wx:key="id">
      <!-- å•†å“å›¾ç‰‡ -->
      <image class="product-image" src="{{item.image}}" mode="aspectFill"></image>
      
      <!-- å•†å“ä¿¡æ¯ -->
      <view class="product-info">
        <view class="product-name">{{item.name}}</view>
        <view class="product-price">
          <text class="price-value">{{item.price}}</text>
          <text class="price-unit">/è¢‹</text>
        </view>
        <view class="product-shipping">ğŸšš è¿è´¹ Â¥{{item.shipping}}</view>
      </view>
      
      <!-- æ•°é‡æ§åˆ¶ -->
      <view class="quantity-control">
        <view class="control-btn minus {{item.quantity === 0 ? 'disabled' : ''}}" 
              bindtap="decreaseQuantity" 
              data-id="{{item.id}}">
          <text class="control-icon">-</text>
        </view>
        <view class="quantity-display">{{item.quantity}}</view>
        <view class="control-btn plus" 
              bindtap="increaseQuantity" 
              data-id="{{item.id}}">
          <text class="control-icon">+</text>
        </view>
      </view>

      <!-- åˆ é™¤æŒ‰é’® -->
      <view class="delete-icon" bindtap="deleteProduct" data-id="{{item.id}}">
        <text>Ã—</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{isEmpty}}">
      <text class="empty-icon">ğŸ›’</text>
      <text class="empty-text">æš‚æ— å•†å“</text>
      <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¤§ç±³å“ç§</text>
    </view>
  </scroll-view>

  <!-- è®¡ç®—ç»“æœåŒºåŸŸ -->
  <view class="result-section" wx:if="{{showResult}}">
    <view class="result-header">
      <text class="result-title">ç»“ç®—è¯¦æƒ…</text>
      <text class="close-result" bindtap="closeResult">Ã—</text>
    </view>
    
    <view class="result-content">
      <!-- æ”¶è´§åœ°å€ -->
      <view class="address-section" bindtap="selectAddress">
        <view class="address-header-row">
          <text class="address-title">ğŸ“ æ”¶è´§åœ°å€</text>
          <text class="address-action">{{selectedAddress ? 'æ›´æ¢' : 'é€‰æ‹©'}} ></text>
        </view>
        <view class="address-content" wx:if="{{selectedAddress}}">
          <view class="address-info-row">
            <text class="address-name">{{selectedAddress.name}}</text>
            <text class="address-phone">{{selectedAddress.phone}}</text>
          </view>
          <view class="address-detail-text">
            {{selectedAddress.province}} {{selectedAddress.city}} {{selectedAddress.district}} {{selectedAddress.detail}}
          </view>
        </view>
        <view class="address-empty" wx:else>
          <text class="empty-hint-text">è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
        </view>
      </view>

      <view class="result-divider"></view>

      <!-- å·²é€‰å•†å“æ˜ç»† -->
      <view class="result-items">
        <view class="items-title">å•†å“æ˜ç»†</view>
        <view class="result-item" wx:for="{{selectedProducts}}" wx:key="id">
          <view class="item-name">{{item.name}} Ã— {{item.quantity}}</view>
          <view class="item-price">Â¥{{item.subtotal}}</view>
        </view>
      </view>

      <view class="result-divider"></view>

      <!-- æ±‡æ€»ä¿¡æ¯ -->
      <view class="result-summary">
        <view class="summary-row">
          <text class="summary-label">å•†å“æ€»ä»·</text>
          <text class="summary-value">Â¥{{totalRicePrice}}</text>
        </view>
        <view class="summary-row">
          <text class="summary-label">è¿è´¹æ€»è®¡</text>
          <text class="summary-value">Â¥{{totalShipping}}</text>
        </view>
        <view class="summary-row total">
          <text class="summary-label">åº”ä»˜æ€»é¢</text>
          <text class="summary-value grand">Â¥{{grandTotal}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="result-actions">
        <button class="save-image-btn secondary" bindtap="saveAsImage">ä¿å­˜è®¢å•</button>
        <button class="confirm-order-btn" bindtap="confirmOrder">ç¡®è®¤ä¸‹å•</button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨è´­ç‰©è½¦æ  -->
  <view class="cart-bar">
    <view class="cart-info">
      <view class="cart-icon-wrapper">
        <text class="cart-icon">ğŸ›’</text>
        <view class="cart-badge" wx:if="{{totalQuantity > 0}}">{{totalQuantity}}</view>
      </view>
      <view class="cart-text">
        <text class="cart-label">å·²é€‰å•†å“</text>
        <text class="cart-count">{{totalQuantity}}ä»¶</text>
      </view>
    </view>
    
    <view class="cart-actions">
      <view class="clear-cart-btn" bindtap="clearCart" wx:if="{{totalQuantity > 0}}">
        <text>ğŸ—‘ï¸ æ¸…ç©º</text>
      </view>
      <view class="checkout-btn {{totalQuantity > 0 ? 'active' : ''}}" bindtap="goCheckout">
        <text wx:if="{{totalQuantity > 0}}">ç«‹å³ç»“ç®—</text>
        <text wx:else>å»ç»“ç®—</text>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ å¤§ç±³å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog"></view>
  <view class="modal-dialog" wx:if="{{showAddDialog}}">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ å¤§ç±³å“ç§</text>
      <text class="modal-close" bindtap="closeAddDialog">Ã—</text>
    </view>
    
    <view class="modal-content">
      <!-- å›¾ç‰‡é€‰æ‹© -->
      <view class="form-item">
        <view class="form-label">
          <text>å•†å“å›¾ç‰‡</text>
          <text class="label-hint">ï¼ˆä»ç›¸å†Œä¸Šä¼ ï¼‰</text>
        </view>
        <view class="image-picker" bindtap="chooseRiceImage">
          <image class="preview-image" src="{{newRiceImage}}" mode="aspectFill"></image>
          <text class="picker-hint">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</text>
          <text class="picker-sub-hint">æ”¯æŒç›¸å†Œé€‰æ‹©æˆ–æ‹ç…§</text>
        </view>
      </view>

      <!-- å¤§ç±³åç§° -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>å¤§ç±³åç§°</text>
        </view>
        <input 
          class="form-input" 
          placeholder="ä¾‹å¦‚: äº”å¸¸ç¨»èŠ±é¦™" 
          value="{{newRiceName}}"
          bindinput="onNewRiceNameInput"
        />
      </view>

      <!-- ä»·æ ¼ -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>ä»·æ ¼ï¼ˆå…ƒ/è¢‹ï¼‰</text>
        </view>
        <input 
          class="form-input" 
          type="digit"
          placeholder="è¯·è¾“å…¥ä»·æ ¼" 
          value="{{newRicePrice}}"
          bindinput="onNewRicePriceInput"
        />
      </view>

      <!-- è¿è´¹ -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>è¿è´¹ï¼ˆå…ƒ/è¢‹ï¼‰</text>
        </view>
        <input 
          class="form-input" 
          type="digit"
          placeholder="è¯·è¾“å…¥è¿è´¹" 
          value="{{newRiceShipping}}"
          bindinput="onNewRiceShippingInput"
        />
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeAddDialog">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="confirmAddRice">ç¡®å®š</button>
    </view>
  </view>

  <!-- éšè—çš„Canvasç”¨äºç”Ÿæˆå›¾ç‰‡ -->
  <canvas 
    type="2d" 
    id="resultCanvas" 
    class="result-canvas"
    style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
  ></canvas>
</view>
