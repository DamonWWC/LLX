<!--index.wxml-->
<view class="container">
  <!-- 顶部导航栏 -->
  <view class="top-bar">
    <view class="top-left">
      <text class="page-title">🌾 林龍香大米商城</text>
    </view>
    <view class="top-right">
      <!-- 工具图标按钮 -->
      <view class="tool-btn {{showMenu ? 'active' : ''}}" bindtap="toggleMenu">
        <text class="tool-icon">⚙</text>
      </view>
    </view>
  </view>

  <!-- 下拉菜单 -->
  <view class="menu-overlay {{showMenu ? 'show' : ''}}" bindtap="closeMenu"></view>
  <view class="dropdown-menu {{showMenu ? 'show' : ''}}">
    <view class="menu-item" bindtap="toggleEditMode">
      <text class="menu-icon">{{isEditMode ? '✓' : '✎'}}</text>
      <text class="menu-text">{{isEditMode ? '完成编辑' : '编辑商品'}}</text>
    </view>
    <view class="menu-divider"></view>
    <view class="menu-item" bindtap="showAddRiceDialogFromMenu">
      <text class="menu-icon">+</text>
      <text class="menu-text">添加品种</text>
    </view>
    <view class="menu-divider"></view>
    <view class="menu-item" bindtap="restoreDefaultProductsFromMenu">
      <text class="menu-icon">↻</text>
      <text class="menu-text">恢复默认</text>
    </view>
  </view>

  <!-- 商品列表 -->
  <scroll-view class="product-list" scroll-y>
    <view class="product-item" wx:for="{{riceProducts}}" wx:key="id">
      <!-- 商品图片 -->
      <image class="product-image" src="{{item.image}}" mode="aspectFill"></image>
      
      <!-- 商品信息 -->
      <view class="product-info">
        <view class="product-name">{{item.name}}</view>
        <view class="product-price">
          <text class="price-value">¥{{item.price}}</text>
          <text class="price-unit">/{{item.unit}}</text>
        </view>
        <view class="product-weight">📦 {{item.weight}}斤/{{item.unit}}</view>
      </view>
      
      <!-- 数量控制 -->
      <view class="quantity-control">
        <view class="control-btn minus {{item.quantity === 0 ? 'disabled' : ''}}" 
              bindtap="decreaseQuantity" 
              data-id="{{item.id}}">
          <text class="control-icon">-</text>
        </view>
        <view class="quantity-display">{{item.quantity}}</view>
        <view class="control-btn plus" 
              bindtap="increaseQuantity" 
              data-id="{{item.id}}">
          <text class="control-icon">+</text>
        </view>
      </view>

      <!-- 删除按钮（仅在编辑模式下显示） -->
      <view class="delete-icon {{isEditMode ? 'show' : ''}}" bindtap="deleteProduct" data-id="{{item.id}}">
        <text>×</text>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{isEmpty}}">
      <text class="empty-icon">🛒</text>
      <text class="empty-text">暂无商品</text>
      <text class="empty-hint">点击右上角添加大米品种</text>
    </view>
  </scroll-view>

  <!-- 计算结果区域 -->
  <view class="result-section" wx:if="{{showResult}}">
    <view class="result-header">
      <text class="result-title">结算详情</text>
      <text class="close-result" bindtap="closeResult">×</text>
    </view>
    
    <view class="result-content">
      <!-- 收货地址 -->
      <view class="address-section" bindtap="selectAddress">
        <view class="address-header-row">
          <text class="address-title">📍 收货地址</text>
          <text class="address-action">{{selectedAddress ? '更换' : '选择'}} ></text>
        </view>
        <view class="address-content" wx:if="{{selectedAddress}}">
          <view class="address-info-row">
            <text class="address-name">{{selectedAddress.name}}</text>
            <text class="address-phone">{{selectedAddress.phone}}</text>
          </view>
          <view class="address-detail-text">
            {{selectedAddress.province}} {{selectedAddress.city}} {{selectedAddress.district}} {{selectedAddress.detail}}
          </view>
        </view>
        <view class="address-empty" wx:else>
          <text class="empty-hint-text">请选择收货地址</text>
        </view>
      </view>

      <view class="result-divider"></view>

      <!-- 已选商品明细 -->
      <view class="result-items">
        <view class="items-title">商品明细</view>
        <view class="result-item" wx:for="{{selectedProducts}}" wx:key="id">
          <view class="item-name">{{item.name}} × {{item.quantity}}</view>
          <view class="item-price">¥{{item.subtotal}}</view>
        </view>
      </view>

      <view class="result-divider"></view>

      <!-- 汇总信息 -->
      <view class="result-summary">
        <view class="summary-row">
          <text class="summary-label">商品总价</text>
          <text class="summary-value">¥{{totalRicePrice}}</text>
        </view>
        <view class="summary-row">
          <text class="summary-label">运费总计</text>
          <text class="summary-value">¥{{totalShipping}}</text>
        </view>
        <view class="summary-row total">
          <text class="summary-label">应付总额</text>
          <text class="summary-value grand">¥{{grandTotal}}</text>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="result-actions">
        <button class="save-image-btn secondary" bindtap="saveAsImage">保存订单</button>
        <button class="confirm-order-btn" bindtap="confirmOrder">确认下单</button>
      </view>
    </view>
  </view>

  <!-- 底部购物车栏 -->
  <view class="cart-bar">
    <view class="cart-info">
      <view class="cart-icon-wrapper">
        <text class="cart-icon">🛒</text>
        <view class="cart-badge" wx:if="{{totalQuantity > 0}}">{{totalQuantity}}</view>
      </view>
      <view class="cart-text">
        <text class="cart-label">已选商品</text>
        <text class="cart-count">{{totalQuantity}}件</text>
      </view>
    </view>
    
    <view class="cart-actions">
      <view class="clear-cart-btn" bindtap="clearCart" wx:if="{{totalQuantity > 0}}">
        <text>🗑️ 清空</text>
      </view>
      <view class="checkout-btn {{totalQuantity > 0 ? 'active' : ''}}" bindtap="goCheckout">
        <text wx:if="{{totalQuantity > 0}}">立即结算</text>
        <text wx:else>去结算</text>
      </view>
    </view>
  </view>

  <!-- 添加大米弹窗 -->
  <view class="modal-mask" wx:if="{{showAddDialog}}" bindtap="closeAddDialog"></view>
  <view class="modal-dialog" wx:if="{{showAddDialog}}">
    <view class="modal-header">
      <text class="modal-title">添加大米品种</text>
      <text class="modal-close" bindtap="closeAddDialog">×</text>
    </view>
    
    <view class="modal-content">
      <!-- 图片选择 -->
      <view class="form-item">
        <view class="form-label">
          <text>商品图片</text>
          <text class="label-hint">（从相册上传）</text>
        </view>
        <view class="image-picker" bindtap="chooseRiceImage">
          <image class="preview-image" src="{{newRiceImage}}" mode="aspectFill"></image>
          <text class="picker-hint">点击上传图片</text>
          <text class="picker-sub-hint">支持相册选择或拍照</text>
        </view>
      </view>

      <!-- 大米名称 -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>大米名称</text>
        </view>
        <input 
          class="form-input" 
          placeholder="例如: 五常稻花香" 
          value="{{newRiceName}}"
          bindinput="onNewRiceNameInput"
        />
      </view>

      <!-- 价格 -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>价格（元）</text>
        </view>
        <input 
          class="form-input" 
          type="digit"
          placeholder="请输入价格" 
          value="{{newRicePrice}}"
          bindinput="onNewRicePriceInput"
        />
      </view>

      <!-- 单位 -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>单位</text>
        </view>
        <radio-group class="radio-group" bindchange="onNewRiceUnitChange">
          <label class="radio-item">
            <radio value="袋" checked="{{newRiceUnit === '袋'}}" color="#ff6034"/>
            <text class="radio-text">袋</text>
          </label>
          <label class="radio-item">
            <radio value="箱" checked="{{newRiceUnit === '箱'}}" color="#ff6034"/>
            <text class="radio-text">箱</text>
          </label>
        </radio-group>
      </view>

      <!-- 重量 -->
      <view class="form-item">
        <view class="form-label">
          <text class="required">*</text>
          <text>重量（斤）</text>
        </view>
        <input 
          class="form-input" 
          type="digit"
          placeholder="请输入重量" 
          value="{{newRiceWeight}}"
          bindinput="onNewRiceWeightInput"
        />
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeAddDialog">取消</button>
      <button class="modal-btn confirm" bindtap="confirmAddRice">确定</button>
    </view>
  </view>

  <!-- 隐藏的Canvas用于生成图片 -->
  <canvas 
    type="2d" 
    id="resultCanvas" 
    class="result-canvas"
    style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
  ></canvas>
</view>
