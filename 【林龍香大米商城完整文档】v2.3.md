# 林龍香大米商城 - 完整项目文档 v2.3

## 📋 目录

1. [项目介绍](#项目介绍)
2. [快速开始](#快速开始)
3. [v2.3 最新更新](#v23-最新更新)
4. [核心功能详解](#核心功能详解)
5. [使用指南](#使用指南)
6. [技术实现](#技术实现)
7. [测试用例](#测试用例)
8. [常见问题](#常见问题)
9. [版本历史](#版本历史)

---

## 项目介绍

### 概述
林龍香大米商城是一个功能完整的微信小程序，专为大米销售业务设计，提供商品管理、购物车、订单管理、地址智能识别、发货单导出等完整功能。

### 主要特性
✅ **商品管理** - 支持添加、编辑、删除商品
✅ **智能购物车** - 便捷的加减数量操作
✅ **地址智能识别** - 自动解析收货地址
✅ **订单管理** - 完整的订单生命周期
✅ **发货单导出** - 一键生成发货单图片
✅ **运费计算** - 根据地区和重量自动计算
✅ **本地存储** - 数据持久化保存

---

## 快速开始

### 环境要求
- 微信开发者工具
- 基础库版本 2.10.0+
- Node.js（可选）

### 安装步骤

1. **克隆项目**
```bash
git clone [项目地址]
cd LLX-SmallProgram
```

2. **打开项目**
   - 启动微信开发者工具
   - 选择"导入项目"
   - 选择项目目录

3. **开始使用**
   - 点击"编译"按钮
   - 即可在模拟器中预览

### 第一次使用
1. 浏览商品列表
2. 点击 + - 按钮调整商品数量
3. 点击"去结算"进入结算页
4. 添加收货地址
5. 提交订单

---

## v2.3 最新更新

### 🎉 重大更新（2025-10-16）

#### 1. 顶部导航栏优化 ⭐⭐⭐
**问题**：添加编辑按钮后界面拥挤

**解决方案**：整合功能按钮到下拉菜单
- 右上角工具图标（⚙）
- 点击显示功能菜单
- 包含：编辑商品、添加品种、恢复默认

**效果**：
- ✅ 界面更加简洁美观
- ✅ 功能集中易于操作
- ✅ 流畅的动画效果

#### 2. 商品编辑功能 ⭐⭐⭐
**问题**：删除按钮始终显示，容易误删

**解决方案**：添加编辑模式
- 默认隐藏删除按钮
- 点击"编辑"按钮进入编辑模式
- 显示删除按钮（带动画）

**效果**：
- ✅ 防止误删商品
- ✅ 编辑和购物操作分离
- ✅ 用户体验更安全

#### 3. Canvas动态高度优化 ⭐⭐⭐
**问题**：订单/发货单截图内容被截断

**解决方案**：动态计算Canvas高度
- 智能预估初始高度
- 两次绘制策略
- 确保内容完整显示

**效果**：
- ✅ 无论商品多少都能完整显示
- ✅ 自动适应内容高度
- ✅ 底部信息不再丢失

#### 4. 商品明细格式优化 ⭐⭐
**新格式**：
```
1.长粒香（10斤/袋）单价：30元
  数量：2袋 ，总重：20斤 ，总价：60元
```

**特点**：
- 信息更完整清晰
- 支持长商品名自动换行
- 价格显示统一为"元"

#### 5. 发货单总计信息优化 ⭐⭐
**新增显示**：
```
总计信息
商品总数：5 份
商品总重：50 斤  ← 加粗红色显示
```

**优化**：
- 修复总重量计算错误
- 突出显示商品总重
- 便于发货员快速识别

#### 6. 订单详情格式优化 ⭐
**价格显示**：统一使用"元"而非"¥"
```
商品总价          180元
总重量            60斤
运费 (2元/斤)     120元
实付款            300元
```

---

## 核心功能详解

### 1. 商品管理

#### 商品展示
- 📦 商品图片（SVG或自定义图片）
- 💰 价格和单位（袋/箱）
- ⚖️ 重量信息（斤/单位）
- 🔢 数量控制（加减按钮）

#### 添加商品
**步骤**：
1. 点击右上角工具图标（⚙）
2. 选择"添加品种"
3. 输入商品信息
   - 名称
   - 单价
   - 单位（袋/箱）
   - 重量（斤）
   - 选择图片（可选）
4. 点击"确定添加"

#### 编辑模式
**使用方法**：
1. 点击工具图标
2. 选择"编辑商品"
3. 商品右上角显示删除按钮
4. 点击删除按钮删除商品
5. 再次点击"完成编辑"退出

#### 恢复默认
- 点击工具图标
- 选择"恢复默认"
- 恢复系统默认的4种大米

### 2. 购物车功能

#### 数量调整
- **减少**：点击 - 按钮
- **增加**：点击 + 按钮
- 自动保存到本地存储

#### 清空购物车
- 在底部点击"清空"按钮
- 确认后清空所有商品数量

### 3. 地址智能识别 v2.2

#### 支持格式

**标准格式**：
```
张三 13800138000
广东省深圳市南山区科技园南路1号
```

**紧凑格式**：
```
李四13900139000广东广州天河区天河路100号
```

**复杂格式**：
```
收货人：王五
电话：13700137000
地址：北京市朝阳区建国路88号SOHO现代城
```

#### 识别规则
1. **姓名识别**
   - 2-4个汉字
   - 支持"先生"、"女士"后缀

2. **电话识别**
   - 11位手机号
   - 固定电话（带区号）

3. **地址识别**
   - 省市区自动分离
   - 详细地址提取
   - 支持模糊匹配

#### 使用方法
1. 点击"添加收货地址"
2. 粘贴完整地址文本
3. 点击"智能识别"
4. 检查识别结果
5. 手动修正（如需要）
6. 保存地址

### 4. 订单管理

#### 创建订单
**流程**：
```
选择商品 → 调整数量 → 去结算 → 选择地址 → 确认信息 → 提交订单
```

#### 查看订单
- 切换到"我的"标签页
- 查看所有历史订单
- 显示订单状态、商品明细、收货地址

#### 订单详情
- 点击"查看详情"按钮
- 弹窗显示完整订单信息
  - 订单号
  - 收货人信息
  - 商品明细（含单价、数量、总重、总价）
  - 价格汇总
  - 下单时间

#### 导出订单
**三种方式**：
1. **📥 订单** - 导出完整订单图片（含价格）
2. **📋 发货单** - 导出发货单图片（不含价格）
3. **📤 分享** - 分享订单到微信

### 5. 发货单功能

#### 发货单内容
```
━━━━━━━━━━━━━━━━━━━━━━
          发货单
━━━━━━━━━━━━━━━━━━━━━━

订单号: ORD1234567890

┌─ 收货信息 ─────────────┐
│ 收件人：张三             │
│ 联系电话：13800138000    │
│ 收货地址：               │
│ 广东省深圳市南山区        │
│ 科技园南路1号            │
└─────────────────────────┘

┌─ 商品明细 ─────────────┐
│ 1.长粒香（10斤/袋）      │
│    数量：2袋 ，总重：20斤 │
│                         │
│ 2.稻花香（10斤/箱）      │
│    数量：1箱 ，总重：10斤 │
└─────────────────────────┘

┌─ 总计信息 ─────────────┐
│ 商品总数：3 份           │
│ 商品总重：30 斤          │
└─────────────────────────┘

* 请核对商品数量和收货地址
下单时间: 2025-10-16 10:30:00
```

#### 导出发货单
1. 进入"我的"页面
2. 找到目标订单
3. 点击"📋 发货单"按钮
4. 自动生成并保存到相册

### 6. 运费计算

#### 计算规则
根据收货地址所在省份和商品总重量计算运费

**运费标准**：
- 广东省：1.5元/斤
- 北京、上海、江苏、浙江：2.0元/斤
- 其他省份：2.5元/斤

**计算公式**：
```
运费 = 总重量(斤) × 运费单价(元/斤)
```

**示例**：
```
商品总重：30斤
收货地址：广东省深圳市
运费单价：1.5元/斤
运费总计：30 × 1.5 = 45元
```

---

## 使用指南

### 商家使用流程

#### 日常销售
```
1. 接收客户订单
   ↓
2. 小程序中添加商品数量
   ↓
3. 填写收货地址（可粘贴客户发来的地址）
   ↓
4. 提交订单
   ↓
5. 导出发货单图片
   ↓
6. 发送给仓库/物流
```

#### 管理商品
```
1. 点击工具图标（⚙）
   ↓
2. 选择"添加品种"添加新商品
   或
   选择"编辑商品"删除商品
   或
   选择"恢复默认"重置商品
```

#### 查看历史
```
1. 切换到"我的"标签
   ↓
2. 查看所有历史订单
   ↓
3. 点击"查看详情"查看订单信息
   或
   点击"📥 订单"导出完整订单
   或
   点击"📋 发货单"导出发货单
```

### 客户使用流程

```
1. 浏览商品
   ↓
2. 点击 +/- 选择数量
   ↓
3. 点击"去结算"
   ↓
4. 添加收货地址
   ↓
5. 确认订单信息
   ↓
6. 提交订单
```

---

## 技术实现

### 技术栈
- **框架**：微信小程序原生开发
- **语言**：JavaScript
- **样式**：WXSS（类CSS）
- **存储**：wx.Storage（本地存储）
- **Canvas**：Canvas 2D API

### 核心技术

#### 1. Canvas动态高度计算

**原理**：
```javascript
// 1. 智能预估初始高度
const estimatedHeight = Math.max(3000, 800 + products.length * 100)

// 2. 第一次绘制，获取实际高度
canvas.height = estimatedHeight * dpr
const actualHeight = await drawContent(ctx, order, estimatedHeight)

// 3. 使用实际高度重新绘制
canvas.height = actualHeight * dpr
await drawContent(ctx, order, actualHeight)
```

**优势**：
- 自动适应内容
- 确保完整显示
- 节省内存

#### 2. 地址智能识别算法

**识别流程**：
```
输入文本
  ↓
清理格式（去除空格、换行）
  ↓
提取姓名（2-4个汉字）
  ↓
提取电话（11位数字）
  ↓
提取省市区（正则匹配）
  ↓
提取详细地址（剩余部分）
  ↓
返回结构化数据
```

**关键代码结构**：
```javascript
function parseAddress(text) {
  // 1. 清理文本
  let cleanText = text.replace(/\s+/g, '')
  
  // 2. 提取姓名
  const nameMatch = cleanText.match(/^[\u4e00-\u9fa5]{2,4}/)
  
  // 3. 提取电话
  const phoneMatch = cleanText.match(/1[3-9]\d{9}/)
  
  // 4. 提取省市区
  const addressMatch = parseRegion(cleanText)
  
  // 5. 组装结果
  return {
    name, phone, province, city, district, detail
  }
}
```

#### 3. 文字智能换行

**实现原理**：
```javascript
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split('')
  let line = ''
  let lineCount = 0
  
  for (let char of words) {
    const testLine = line + char
    const metrics = ctx.measureText(testLine)
    
    if (metrics.width > maxWidth && line) {
      ctx.fillText(line, x, y + lineCount * lineHeight)
      line = char
      lineCount++
    } else {
      line = testLine
    }
  }
  
  ctx.fillText(line, x, y + lineCount * lineHeight)
  return lineCount + 1  // 返回行数
}
```

**特点**：
- 逐字测量宽度
- 超宽自动换行
- 返回实际行数
- 动态调整间距

#### 4. 本地存储管理

**数据结构**：
```javascript
// 商品数据
riceProducts: [
  {
    id: 1,
    name: '长粒香',
    price: 30,
    unit: '袋',
    weight: 10,
    quantity: 0,
    image: 'data:image/svg+xml,...'
  }
]

// 订单数据
orderList: [
  {
    id: 1234567890,
    orderNo: 'ORD1234567890',
    products: [...],
    address: {...},
    totalRicePrice: 180,
    totalWeight: 60,
    shippingRate: 2,
    totalShipping: 120,
    grandTotal: 300,
    status: '待发货',
    createTime: '2025-10-16 10:30:00'
  }
]

// 地址数据
addressList: [
  {
    id: 1,
    name: '张三',
    phone: '13800138000',
    province: '广东省',
    city: '深圳市',
    district: '南山区',
    detail: '科技园南路1号',
    isDefault: true
  }
]
```

**存储API**：
```javascript
// 保存数据
wx.setStorageSync('key', data)

// 读取数据
const data = wx.getStorageSync('key')

// 删除数据
wx.removeStorageSync('key')
```

### 性能优化

#### 1. Canvas优化
- 使用transform代替top/left
- 启用硬件加速
- 智能预估高度减少重绘

#### 2. 动画优化
- 使用CSS3 transition
- 贝塞尔曲线缓动
- 60fps流畅动画

#### 3. 事件优化
- 防止重复点击
- 节流和防抖
- 事件委托

---

## 测试用例

### 地址识别测试

#### 测试用例1：标准格式
**输入**：
```
张三 13800138000
广东省深圳市南山区科技园南路1号
```
**预期输出**：
- 姓名：张三
- 电话：13800138000
- 省：广东省
- 市：深圳市
- 区：南山区
- 详细：科技园南路1号

#### 测试用例2：紧凑格式
**输入**：
```
李四13900139000广东广州天河区天河路100号
```
**预期输出**：
- 姓名：李四
- 电话：13900139000
- 省：广东省
- 市：广州市
- 区：天河区
- 详细：天河路100号

#### 测试用例3：超长地址
**输入**：
```
王五 13700137000
北京市朝阳区建国路88号SOHO现代城A座12层1201室
```
**预期输出**：
- 地址自动换行
- 不会重叠
- 完整显示

### Canvas高度测试

#### 测试场景1：少量商品
- 商品数：1-2个
- 预期：完整显示，高度约600-800px

#### 测试场景2：中等商品
- 商品数：5-8个
- 预期：完整显示，高度约1300-1600px

#### 测试场景3：大量商品
- 商品数：10-15个
- 预期：完整显示，高度约1800-2300px

#### 测试场景4：极端情况
- 商品数：20个以上
- 长地址：超过80字
- 预期：高度自动调整，完整显示

---

## 常见问题

### Q1：商品图片不显示？
**原因**：外部图片链接失效
**解决**：
1. 使用默认SVG图片
2. 或从相册选择本地图片

### Q2：地址识别不准确？
**原因**：地址格式不标准
**解决**：
1. 使用标准格式：姓名 + 电话 + 地址
2. 手动修正识别结果
3. 参考地址格式示例

### Q3：订单图片不完整？
**原因**：（已修复）Canvas高度不足
**解决**：v2.3版本已实现动态高度，确保完整显示

### Q4：如何批量删除商品？
**步骤**：
1. 点击工具图标
2. 选择"编辑商品"
3. 依次点击要删除的商品
4. 完成后点击"完成编辑"

### Q5：运费如何计算？
**规则**：
- 根据收货地址省份和商品总重量
- 不同省份运费单价不同
- 公式：运费 = 总重量 × 运费单价

### Q6：能否自定义运费？
**方法**：
修改 `utils/shippingConfig.js` 文件中的运费配置

### Q7：如何导出多个订单？
**当前**：逐个导出
**未来**：计划添加批量导出功能

### Q8：数据会丢失吗？
**保障**：
- 所有数据保存在本地存储
- 卸载小程序会清除数据
- 建议定期导出重要订单

---

## 版本历史

### v2.3 (2025-10-16) 🎉 重大更新

#### 界面优化
- ✅ 顶部导航栏下拉菜单
- ✅ 商品编辑模式
- ✅ 工具图标动画效果

#### 功能增强
- ✅ Canvas动态高度计算
- ✅ 商品明细格式优化
- ✅ 发货单总计信息优化
- ✅ 价格显示格式统一

#### 技术改进
- ✅ 文字智能换行
- ✅ 动态间距调整
- ✅ 性能优化

### v2.2 (之前版本)

#### 地址识别增强
- ✅ 支持更多地址格式
- ✅ 提升识别准确率
- ✅ 优化识别算法

#### 发货单功能
- ✅ 新增发货单导出
- ✅ 不含价格信息
- ✅ 便于发货流程

#### 商品明细优化
- ✅ 显示单位信息
- ✅ 显示重量信息
- ✅ 格式更清晰

### v2.1 (之前版本)

#### 基础功能
- ✅ 商品管理
- ✅ 购物车
- ✅ 订单管理
- ✅ 地址管理
- ✅ 本地存储

#### UI美化
- ✅ 淘宝风格设计
- ✅ 渐变色导航栏
- ✅ 卡片式布局
- ✅ 流畅动画

---

## 项目结构

```
LLX-SmallProgram/
├── pages/
│   ├── index/              # 商品页面
│   │   ├── index.js
│   │   ├── index.wxml
│   │   ├── index.wxss
│   │   └── index.json
│   ├── checkout/           # 结算页面
│   ├── orders/             # 订单页面
│   ├── address/            # 地址管理
│   ├── shipping/           # 发货单页面
│   └── my/                 # 我的页面
├── utils/
│   ├── addressParser.js    # 地址识别算法
│   ├── shippingConfig.js   # 运费配置
│   └── util.js            # 工具函数
├── images/                 # 图片资源
├── app.js                 # 应用入口
├── app.json               # 应用配置
├── app.wxss              # 全局样式
└── README.md             # 项目说明
```

---

## 开发说明

### 修改运费配置

编辑 `utils/shippingConfig.js`：

```javascript
const shippingRates = {
  '广东省': 1.5,
  '北京市': 2.0,
  '上海市': 2.0,
  // 添加更多省份...
  'default': 2.5
}
```

### 修改默认商品

编辑 `pages/index/index.js` 中的 `getDefaultProducts()` 方法：

```javascript
getDefaultProducts() {
  return [
    {
      id: 1,
      name: '商品名称',
      price: 30,
      unit: '袋',
      weight: 10,
      image: '...',
      quantity: 0
    }
  ]
}
```

### 自定义主题色

编辑 `app.wxss`：

```css
:root {
  --primary-color: #ff6034;
  --secondary-color: #ee0a24;
}
```

---

## 注意事项

### 1. 数据备份
- 小程序数据保存在本地
- 卸载会清除所有数据
- 重要订单建议及时导出

### 2. 图片选择
- 支持从相册选择图片
- 推荐使用SVG默认图片
- 外部链接可能失效

### 3. 地址识别
- 建议使用标准格式
- 识别后检查准确性
- 可手动修正错误

### 4. Canvas限制
- iOS最大16384px
- Android最大8192px
- 单个订单建议不超过30个商品

---

## 技术支持

### 遇到问题？

1. **查看文档**：先查看本文档相关章节
2. **检查日志**：查看微信开发者工具控制台
3. **重启小程序**：关闭后重新打开
4. **清除缓存**：开发工具中清除缓存数据

### 常见错误处理

**Canvas生成失败**
```javascript
// 检查Canvas节点是否存在
if (!res || !res[0]) {
  console.error('Canvas节点未找到')
  return
}
```

**地址识别失败**
```javascript
// 检查输入文本
if (!addressText || addressText.length < 10) {
  console.error('地址文本过短')
  return
}
```

---

## 未来规划

### 短期计划
- [ ] 批量导出订单
- [ ] 订单搜索功能
- [ ] 统计报表功能
- [ ] 客户管理功能

### 长期计划
- [ ] 云端数据同步
- [ ] 多商家支持
- [ ] 会员系统
- [ ] 优惠券功能
- [ ] 支付接口对接

---

## 致谢

感谢所有使用和支持本项目的用户！

如有任何问题或建议，欢迎反馈。

---

## 许可证

本项目仅供学习和参考使用。

---

**文档版本**：v2.3  
**最后更新**：2025年10月16日  
**维护状态**：✅ 活跃维护中

---

© 2025 林龍香大米商城 All Rights Reserved.

