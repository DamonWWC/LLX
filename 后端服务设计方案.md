# æ—é¾é¦™å¤§ç±³å•†åŸ - åç«¯æœåŠ¡å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ç³»ç»Ÿæ¶æ„è®¾è®¡)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
4. [æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)è®¾è®¡](#æ•°æ®ä¼ è¾“å¯¹è±¡dtoè®¾è®¡)
5. [.NETé¡¹ç›®ç»“æ„](#neté¡¹ç›®ç»“æ„)
6. [æ ¸å¿ƒä»£ç å®ç°è¯´æ˜](#æ ¸å¿ƒä»£ç å®ç°è¯´æ˜)
7. [éƒ¨ç½²æ–¹æ¡ˆ](#éƒ¨ç½²æ–¹æ¡ˆ)
8. [å°ç¨‹åºå¯¹æ¥è¯´æ˜](#å°ç¨‹åºå¯¹æ¥è¯´æ˜)
9. [å¼€å‘æ­¥éª¤](#å¼€å‘æ­¥éª¤)

---

## ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¾®ä¿¡å°ç¨‹åºå®¢æˆ·ç«¯                       â”‚
â”‚    (pages/index, checkout, orders, address, shipping)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTPS
                       â”‚ RESTful API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    .NET 8 Web API å±‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Controllers  â”‚  Services    â”‚  Repositories            â”‚ â”‚
â”‚  â”‚  (APIç«¯ç‚¹)   â”‚  (ä¸šåŠ¡é€»è¾‘)  â”‚  (æ•°æ®è®¿é—®)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Entity Framework Core
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PostgreSQL æ•°æ®åº“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Products â”‚ Orders   â”‚ Addressesâ”‚ OrderItems         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**ï¼š.NET 8 Web API
- **ORM**ï¼šEntity Framework Core 8
- **æ•°æ®åº“**ï¼šPostgreSQL 16
- **å¼€å‘å·¥å…·**ï¼šVisual Studio 2022 / VS Code
- **APIæ–‡æ¡£**ï¼šSwagger / OpenAPI
- **éƒ¨ç½²å¹³å°**ï¼šIIS / Docker / Linux

---

## æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“ ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Products      â”‚         â”‚   Addresses     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Id (PK)         â”‚         â”‚ Id (PK)         â”‚
â”‚ Name            â”‚         â”‚ Name            â”‚
â”‚ Price           â”‚         â”‚ Phone           â”‚
â”‚ Unit            â”‚         â”‚ Province        â”‚
â”‚ Weight          â”‚         â”‚ City            â”‚
â”‚ Image           â”‚         â”‚ District        â”‚
â”‚ Quantity        â”‚         â”‚ Detail          â”‚
â”‚ CreatedAt       â”‚         â”‚ IsDefault       â”‚
â”‚ UpdatedAt       â”‚         â”‚ CreatedAt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ UpdatedAt       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚
        â”‚                             â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
        â””â”€â”€â”€â”‚   Orders        â”‚â”€â”€â”€â”€â”€â”€â”˜
            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
            â”‚ Id (PK)         â”‚
            â”‚ OrderNo         â”‚
            â”‚ AddressId (FK)  â”‚
            â”‚ TotalRicePrice  â”‚
            â”‚ TotalWeight     â”‚
            â”‚ ShippingRate    â”‚
            â”‚ TotalShipping   â”‚
            â”‚ GrandTotal      â”‚
            â”‚ Status          â”‚
            â”‚ CreatedAt       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 1:N
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   OrderItems    â”‚
            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
            â”‚ Id (PK)         â”‚
            â”‚ OrderId (FK)    â”‚
            â”‚ ProductId (FK)  â”‚
            â”‚ ProductName     â”‚
            â”‚ ProductPrice    â”‚
            â”‚ ProductUnit     â”‚
            â”‚ ProductWeight   â”‚
            â”‚ Quantity        â”‚
            â”‚ Subtotal        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PostgreSQL è¡¨ç»“æ„

#### 1. Productsï¼ˆå•†å“è¡¨ï¼‰

```sql
CREATE TABLE "Products" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(100) NOT NULL,
    "Price" DECIMAL(10,2) NOT NULL,
    "Unit" VARCHAR(20) NOT NULL,            -- è¢‹/ç®±
    "Weight" DECIMAL(10,2) NOT NULL,        -- å•ä½é‡é‡ï¼ˆæ–¤ï¼‰
    "Image" TEXT,                           -- Base64æˆ–å›¾ç‰‡URL
    "Quantity" INT DEFAULT 0,               -- é»˜è®¤åº“å­˜æ•°é‡
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX "idx_products_name" ON "Products"("Name");
```

#### 2. Addressesï¼ˆæ”¶è´§åœ°å€è¡¨ï¼‰

```sql
CREATE TABLE "Addresses" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(50) NOT NULL,            -- æ”¶è´§äººå§“å
    "Phone" VARCHAR(20) NOT NULL,           -- è”ç³»ç”µè¯
    "Province" VARCHAR(50) NOT NULL,        -- çœä»½
    "City" VARCHAR(50) NOT NULL,            -- åŸå¸‚
    "District" VARCHAR(50),                 -- åŒºå¿
    "Detail" VARCHAR(200) NOT NULL,         -- è¯¦ç»†åœ°å€
    "IsDefault" BOOLEAN DEFAULT FALSE,      -- æ˜¯å¦é»˜è®¤åœ°å€
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX "idx_addresses_default" ON "Addresses"("IsDefault");
CREATE INDEX "idx_addresses_phone" ON "Addresses"("Phone");
```

#### 3. Ordersï¼ˆè®¢å•è¡¨ï¼‰

```sql
CREATE TABLE "Orders" (
    "Id" SERIAL PRIMARY KEY,
    "OrderNo" VARCHAR(50) UNIQUE NOT NULL,  -- è®¢å•å·
    "AddressId" INT NOT NULL,               -- æ”¶è´§åœ°å€ID
    "TotalRicePrice" DECIMAL(10,2) NOT NULL,-- å•†å“æ€»ä»·
    "TotalWeight" DECIMAL(10,2) NOT NULL,   -- æ€»é‡é‡ï¼ˆæ–¤ï¼‰
    "ShippingRate" DECIMAL(10,2) NOT NULL,  -- è¿è´¹å•ä»·ï¼ˆå…ƒ/æ–¤ï¼‰
    "TotalShipping" DECIMAL(10,2) NOT NULL, -- è¿è´¹æ€»è®¡
    "GrandTotal" DECIMAL(10,2) NOT NULL,    -- è®¢å•æ€»é‡‘é¢
    "Status" VARCHAR(20) NOT NULL DEFAULT 'å¾…å‘è´§', -- è®¢å•çŠ¶æ€
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT "fk_orders_address" FOREIGN KEY ("AddressId") 
        REFERENCES "Addresses"("Id") ON DELETE RESTRICT
);

CREATE INDEX "idx_orders_orderno" ON "Orders"("OrderNo");
CREATE INDEX "idx_orders_status" ON "Orders"("Status");
CREATE INDEX "idx_orders_createdat" ON "Orders"("CreatedAt" DESC);
```

#### 4. OrderItemsï¼ˆè®¢å•æ˜ç»†è¡¨ï¼‰

```sql
CREATE TABLE "OrderItems" (
    "Id" SERIAL PRIMARY KEY,
    "OrderId" INT NOT NULL,                 -- è®¢å•ID
    "ProductId" INT NOT NULL,               -- å•†å“ID
    "ProductName" VARCHAR(100) NOT NULL,    -- å•†å“åç§°ï¼ˆå†—ä½™å­˜å‚¨ï¼‰
    "ProductPrice" DECIMAL(10,2) NOT NULL,  -- å•†å“å•ä»·ï¼ˆå†—ä½™å­˜å‚¨ï¼‰
    "ProductUnit" VARCHAR(20) NOT NULL,     -- å•†å“å•ä½ï¼ˆå†—ä½™å­˜å‚¨ï¼‰
    "ProductWeight" DECIMAL(10,2) NOT NULL, -- å•†å“é‡é‡ï¼ˆå†—ä½™å­˜å‚¨ï¼‰
    "Quantity" INT NOT NULL,                -- è´­ä¹°æ•°é‡
    "Subtotal" DECIMAL(10,2) NOT NULL,      -- å°è®¡
    
    CONSTRAINT "fk_orderitems_order" FOREIGN KEY ("OrderId") 
        REFERENCES "Orders"("Id") ON DELETE CASCADE,
    CONSTRAINT "fk_orderitems_product" FOREIGN KEY ("ProductId") 
        REFERENCES "Products"("Id") ON DELETE RESTRICT
);

CREATE INDEX "idx_orderitems_orderid" ON "OrderItems"("OrderId");
CREATE INDEX "idx_orderitems_productid" ON "OrderItems"("ProductId");
```

#### 5. ShippingRatesï¼ˆè¿è´¹é…ç½®è¡¨ï¼‰

```sql
CREATE TABLE "ShippingRates" (
    "Id" SERIAL PRIMARY KEY,
    "Province" VARCHAR(50) NOT NULL UNIQUE, -- çœä»½åç§°
    "Rate" DECIMAL(10,2) NOT NULL,          -- è¿è´¹å•ä»·ï¼ˆå…ƒ/æ–¤ï¼‰
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆå§‹åŒ–è¿è´¹æ•°æ®
INSERT INTO "ShippingRates" ("Province", "Rate") VALUES
('å¹¿ä¸œçœ', 1.5),
('åŒ—äº¬å¸‚', 2.0),
('ä¸Šæµ·å¸‚', 2.0),
('æ±Ÿè‹çœ', 2.0),
('æµ™æ±Ÿçœ', 2.0),
('default', 2.5);  -- é»˜è®¤è¿è´¹
```

---

## APIæ¥å£è®¾è®¡

### APIåŸºç¡€ä¿¡æ¯

- **Base URL**: `https://api.llxrice.com/api/v1`
- **æ•°æ®æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8
- **æ—¶é—´æ ¼å¼**: ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ)

### ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {},
  "timestamp": "2025-10-16T10:30:00.000Z"
}
```

### 1. å•†å“ç®¡ç†æ¥å£ï¼ˆProductsï¼‰

#### 1.1 è·å–å•†å“åˆ—è¡¨

```
GET /products
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è·å–æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "name": "ç¨»èŠ±é¦™",
      "price": 40.00,
      "unit": "è¢‹",
      "weight": 10.00,
      "image": "data:image/svg+xml,...",
      "quantity": 0,
      "createdAt": "2025-10-16T10:00:00Z",
      "updatedAt": "2025-10-16T10:00:00Z"
    }
  ]
}
```

#### 1.2 è·å–å•ä¸ªå•†å“

```
GET /products/{id}
```

#### 1.3 åˆ›å»ºå•†å“

```
POST /products
Content-Type: application/json

{
  "name": "ç¨»èŠ±é¦™",
  "price": 40.00,
  "unit": "è¢‹",
  "weight": 10.00,
  "image": "data:image/svg+xml,...",
  "quantity": 0
}
```

#### 1.4 æ›´æ–°å•†å“

```
PUT /products/{id}
Content-Type: application/json

{
  "name": "ç¨»èŠ±é¦™",
  "price": 45.00,
  "unit": "è¢‹",
  "weight": 10.00,
  "image": "data:image/svg+xml,...",
  "quantity": 0
}
```

#### 1.5 åˆ é™¤å•†å“

```
DELETE /products/{id}
```

### 2. åœ°å€ç®¡ç†æ¥å£ï¼ˆAddressesï¼‰

#### 2.1 è·å–åœ°å€åˆ—è¡¨

```
GET /addresses
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è·å–æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "name": "å¼ ä¸‰",
      "phone": "13800138000",
      "province": "å¹¿ä¸œçœ",
      "city": "æ·±åœ³å¸‚",
      "district": "å—å±±åŒº",
      "detail": "ç§‘æŠ€å›­å—è·¯1å·",
      "isDefault": true,
      "createdAt": "2025-10-16T10:00:00Z",
      "updatedAt": "2025-10-16T10:00:00Z"
    }
  ]
}
```

#### 2.2 è·å–å•ä¸ªåœ°å€

```
GET /addresses/{id}
```

#### 2.3 åˆ›å»ºåœ°å€

```
POST /addresses
Content-Type: application/json

{
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "province": "å¹¿ä¸œçœ",
  "city": "æ·±åœ³å¸‚",
  "district": "å—å±±åŒº",
  "detail": "ç§‘æŠ€å›­å—è·¯1å·",
  "isDefault": true
}
```

#### 2.4 æ›´æ–°åœ°å€

```
PUT /addresses/{id}
```

#### 2.5 åˆ é™¤åœ°å€

```
DELETE /addresses/{id}
```

#### 2.6 è®¾ç½®é»˜è®¤åœ°å€

```
PUT /addresses/{id}/set-default
```

#### 2.7 åœ°å€æ™ºèƒ½è¯†åˆ«

```
POST /addresses/parse
Content-Type: application/json

{
  "text": "å¼ ä¸‰ 13800138000 å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—è·¯1å·"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è¯†åˆ«æˆåŠŸ",
  "data": {
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "province": "å¹¿ä¸œçœ",
    "city": "æ·±åœ³å¸‚",
    "district": "å—å±±åŒº",
    "detail": "ç§‘æŠ€å›­å—è·¯1å·"
  }
}
```

### 3. è®¢å•ç®¡ç†æ¥å£ï¼ˆOrdersï¼‰

#### 3.1 è·å–è®¢å•åˆ—è¡¨

```
GET /orders?page=1&pageSize=10&status=å¾…å‘è´§
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `pageSize`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤10ï¼‰
- `status`: è®¢å•çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "items": [
      {
        "id": 1,
        "orderNo": "ORD1729123456789",
        "address": {
          "id": 1,
          "name": "å¼ ä¸‰",
          "phone": "13800138000",
          "province": "å¹¿ä¸œçœ",
          "city": "æ·±åœ³å¸‚",
          "district": "å—å±±åŒº",
          "detail": "ç§‘æŠ€å›­å—è·¯1å·"
        },
        "items": [
          {
            "id": 1,
            "productId": 1,
            "productName": "ç¨»èŠ±é¦™",
            "productPrice": 40.00,
            "productUnit": "è¢‹",
            "productWeight": 10.00,
            "quantity": 2,
            "subtotal": 80.00
          }
        ],
        "totalRicePrice": 80.00,
        "totalWeight": 20.00,
        "shippingRate": 1.50,
        "totalShipping": 30.00,
        "grandTotal": 110.00,
        "status": "å¾…å‘è´§",
        "createdAt": "2025-10-16T10:00:00Z",
        "updatedAt": "2025-10-16T10:00:00Z"
      }
    ]
  }
}
```

#### 3.2 è·å–è®¢å•è¯¦æƒ…

```
GET /orders/{id}
```

#### 3.3 åˆ›å»ºè®¢å•

```
POST /orders
Content-Type: application/json

{
  "addressId": 1,
  "items": [
    {
      "productId": 1,
      "quantity": 2
    },
    {
      "productId": 2,
      "quantity": 1
    }
  ]
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "orderNo": "ORD1729123456789",
    "grandTotal": 110.00
  }
}
```

#### 3.4 æ›´æ–°è®¢å•çŠ¶æ€

```
PUT /orders/{id}/status
Content-Type: application/json

{
  "status": "å·²å‘è´§"
}
```

#### 3.5 åˆ é™¤è®¢å•

```
DELETE /orders/{id}
```

#### 3.6 æ‰¹é‡åˆ é™¤è®¢å•

```
DELETE /orders/batch
Content-Type: application/json

{
  "orderIds": [1, 2, 3]
}
```

### 4. è¿è´¹è®¡ç®—æ¥å£ï¼ˆShippingï¼‰

#### 4.1 è®¡ç®—è¿è´¹

```
POST /shipping/calculate
Content-Type: application/json

{
  "province": "å¹¿ä¸œçœ",
  "weight": 20.00
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è®¡ç®—æˆåŠŸ",
  "data": {
    "province": "å¹¿ä¸œçœ",
    "weight": 20.00,
    "rate": 1.50,
    "shipping": 30.00
  }
}
```

#### 4.2 è·å–è¿è´¹é…ç½®

```
GET /shipping/rates
```

#### 4.3 æ›´æ–°è¿è´¹é…ç½®

```
PUT /shipping/rates/{province}
Content-Type: application/json

{
  "rate": 1.80
}
```

---

## æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)è®¾è®¡

### Product DTOs

```csharp
// åˆ›å»ºå•†å“DTO
public class CreateProductDto
{
    [Required]
    [MaxLength(100)]
    public string Name { get; set; }
    
    [Required]
    [Range(0.01, 999999.99)]
    public decimal Price { get; set; }
    
    [Required]
    [MaxLength(20)]
    public string Unit { get; set; }
    
    [Required]
    [Range(0.01, 999999.99)]
    public decimal Weight { get; set; }
    
    public string Image { get; set; }
    
    [Range(0, 999999)]
    public int Quantity { get; set; } = 0;
}

// æ›´æ–°å•†å“DTO
public class UpdateProductDto : CreateProductDto { }

// å•†å“å“åº”DTO
public class ProductDto
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public string Unit { get; set; }
    public decimal Weight { get; set; }
    public string Image { get; set; }
    public int Quantity { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### Address DTOs

```csharp
// åˆ›å»ºåœ°å€DTO
public class CreateAddressDto
{
    [Required]
    [MaxLength(50)]
    public string Name { get; set; }
    
    [Required]
    [Phone]
    [MaxLength(20)]
    public string Phone { get; set; }
    
    [Required]
    [MaxLength(50)]
    public string Province { get; set; }
    
    [Required]
    [MaxLength(50)]
    public string City { get; set; }
    
    [MaxLength(50)]
    public string District { get; set; }
    
    [Required]
    [MaxLength(200)]
    public string Detail { get; set; }
    
    public bool IsDefault { get; set; } = false;
}

// åœ°å€è§£æè¯·æ±‚DTO
public class ParseAddressDto
{
    [Required]
    public string Text { get; set; }
}

// åœ°å€å“åº”DTO
public class AddressDto
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Phone { get; set; }
    public string Province { get; set; }
    public string City { get; set; }
    public string District { get; set; }
    public string Detail { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### Order DTOs

```csharp
// è®¢å•æ˜ç»†é¡¹DTO
public class OrderItemDto
{
    public int Id { get; set; }
    public int ProductId { get; set; }
    public string ProductName { get; set; }
    public decimal ProductPrice { get; set; }
    public string ProductUnit { get; set; }
    public decimal ProductWeight { get; set; }
    public int Quantity { get; set; }
    public decimal Subtotal { get; set; }
}

// åˆ›å»ºè®¢å•é¡¹DTO
public class CreateOrderItemDto
{
    [Required]
    public int ProductId { get; set; }
    
    [Required]
    [Range(1, 999999)]
    public int Quantity { get; set; }
}

// åˆ›å»ºè®¢å•DTO
public class CreateOrderDto
{
    [Required]
    public int AddressId { get; set; }
    
    [Required]
    [MinLength(1)]
    public List<CreateOrderItemDto> Items { get; set; }
}

// è®¢å•å“åº”DTO
public class OrderDto
{
    public int Id { get; set; }
    public string OrderNo { get; set; }
    public AddressDto Address { get; set; }
    public List<OrderItemDto> Items { get; set; }
    public decimal TotalRicePrice { get; set; }
    public decimal TotalWeight { get; set; }
    public decimal ShippingRate { get; set; }
    public decimal TotalShipping { get; set; }
    public decimal GrandTotal { get; set; }
    public string Status { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// è®¢å•åˆ—è¡¨é¡¹DTOï¼ˆç®€åŒ–ç‰ˆï¼‰
public class OrderListItemDto
{
    public int Id { get; set; }
    public string OrderNo { get; set; }
    public string AddressName { get; set; }
    public string AddressPhone { get; set; }
    public int ItemCount { get; set; }
    public decimal GrandTotal { get; set; }
    public string Status { get; set; }
    public DateTime CreatedAt { get; set; }
}

// åˆ†é¡µç»“æœDTO
public class PagedResultDto<T>
{
    public int Total { get; set; }
    public int Page { get; set; }
    public int PageSize { get; set; }
    public List<T> Items { get; set; }
}
```

---

## .NETé¡¹ç›®ç»“æ„

```
LLXRice.WebApi/
â”œâ”€â”€ LLXRice.WebApi.sln                  # è§£å†³æ–¹æ¡ˆæ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ LLXRice.WebApi/                 # Web API é¡¹ç›®
â”‚   â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductsController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ AddressesController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ OrdersController.cs
â”‚   â”‚   â”‚   â””â”€â”€ ShippingController.cs
â”‚   â”‚   â”œâ”€â”€ Models/                     # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ Entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Product.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Address.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Order.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderItem.cs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ShippingRate.cs
â”‚   â”‚   â”‚   â””â”€â”€ DTOs/                   # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”‚       â”œâ”€â”€ ProductDtos.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ AddressDtos.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ OrderDtos.cs
â”‚   â”‚   â”‚       â””â”€â”€ ApiResponse.cs
â”‚   â”‚   â”œâ”€â”€ Services/                   # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ Interfaces/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IProductService.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IAddressService.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IOrderService.cs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ IShippingService.cs
â”‚   â”‚   â”‚   â””â”€â”€ Implementations/
â”‚   â”‚   â”‚       â”œâ”€â”€ ProductService.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ AddressService.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ OrderService.cs
â”‚   â”‚   â”‚       â””â”€â”€ ShippingService.cs
â”‚   â”‚   â”œâ”€â”€ Repositories/               # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ Interfaces/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IProductRepository.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IAddressRepository.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IOrderRepository.cs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ IShippingRateRepository.cs
â”‚   â”‚   â”‚   â””â”€â”€ Implementations/
â”‚   â”‚   â”‚       â”œâ”€â”€ ProductRepository.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ AddressRepository.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ OrderRepository.cs
â”‚   â”‚   â”‚       â””â”€â”€ ShippingRateRepository.cs
â”‚   â”‚   â”œâ”€â”€ Data/
â”‚   â”‚   â”‚   â”œâ”€â”€ ApplicationDbContext.cs # EF Core DbContext
â”‚   â”‚   â”‚   â””â”€â”€ Migrations/             # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â”œâ”€â”€ Utilities/
â”‚   â”‚   â”‚   â”œâ”€â”€ AddressParser.cs        # åœ°å€è§£æå·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ OrderNumberGenerator.cs # è®¢å•å·ç”Ÿæˆå™¨
â”‚   â”‚   â”œâ”€â”€ Middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ ExceptionMiddleware.cs  # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚   â”‚   â”‚   â””â”€â”€ LoggingMiddleware.cs    # è¯·æ±‚æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ appsettings.json
â”‚   â”‚   â”œâ”€â”€ appsettings.Development.json
â”‚   â”‚   â”œâ”€â”€ Program.cs
â”‚   â”‚   â””â”€â”€ LLXRice.WebApi.csproj
â”‚   â””â”€â”€ LLXRice.Tests/                  # å•å…ƒæµ‹è¯•é¡¹ç›®
â”‚       â”œâ”€â”€ Controllers/
â”‚       â”œâ”€â”€ Services/
â”‚       â””â”€â”€ LLXRice.Tests.csproj
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ APIæ–‡æ¡£.md
â””â”€â”€ README.md
```

### å…³é”®æ–‡ä»¶è¯´æ˜

#### Program.csï¼ˆåº”ç”¨ç¨‹åºå…¥å£ï¼‰

```csharp
using Microsoft.EntityFrameworkCore;
using LLXRice.WebApi.Data;
using LLXRice.WebApi.Services.Interfaces;
using LLXRice.WebApi.Services.Implementations;
using LLXRice.WebApi.Repositories.Interfaces;
using LLXRice.WebApi.Repositories.Implementations;

var builder = WebApplication.CreateBuilder(args);

// æ·»åŠ æœåŠ¡åˆ°å®¹å™¨
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// é…ç½®æ•°æ®åº“
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection")));

// é…ç½®CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});

// æ³¨å†Œä»“å‚¨
builder.Services.AddScoped<IProductRepository, ProductRepository>();
builder.Services.AddScoped<IAddressRepository, AddressRepository>();
builder.Services.AddScoped<IOrderRepository, OrderRepository>();
builder.Services.AddScoped<IShippingRateRepository, ShippingRateRepository>();

// æ³¨å†ŒæœåŠ¡
builder.Services.AddScoped<IProductService, ProductService>();
builder.Services.AddScoped<IAddressService, AddressService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<IShippingService, ShippingService>();

// é…ç½®AutoMapperï¼ˆå¦‚æœä½¿ç”¨ï¼‰
builder.Services.AddAutoMapper(typeof(Program));

var app = builder.Build();

// é…ç½®HTTPè¯·æ±‚ç®¡é“
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseCors("AllowAll");
app.UseAuthorization();
app.MapControllers();

app.Run();
```

#### appsettings.json

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=llxrice;Username=postgres;Password=your_password"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

#### ApplicationDbContext.cs

```csharp
using Microsoft.EntityFrameworkCore;
using LLXRice.WebApi.Models.Entities;

namespace LLXRice.WebApi.Data
{
    public class ApplicationDbContext : DbContext
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        public DbSet<Product> Products { get; set; }
        public DbSet<Address> Addresses { get; set; }
        public DbSet<Order> Orders { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<ShippingRate> ShippingRates { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // é…ç½®Product
            modelBuilder.Entity<Product>(entity =>
            {
                entity.Property(e => e.Price).HasPrecision(10, 2);
                entity.Property(e => e.Weight).HasPrecision(10, 2);
            });

            // é…ç½®Order
            modelBuilder.Entity<Order>(entity =>
            {
                entity.Property(e => e.TotalRicePrice).HasPrecision(10, 2);
                entity.Property(e => e.TotalWeight).HasPrecision(10, 2);
                entity.Property(e => e.ShippingRate).HasPrecision(10, 2);
                entity.Property(e => e.TotalShipping).HasPrecision(10, 2);
                entity.Property(e => e.GrandTotal).HasPrecision(10, 2);
                
                entity.HasOne(e => e.Address)
                      .WithMany()
                      .HasForeignKey(e => e.AddressId)
                      .OnDelete(DeleteBehavior.Restrict);
            });

            // é…ç½®OrderItem
            modelBuilder.Entity<OrderItem>(entity =>
            {
                entity.Property(e => e.ProductPrice).HasPrecision(10, 2);
                entity.Property(e => e.ProductWeight).HasPrecision(10, 2);
                entity.Property(e => e.Subtotal).HasPrecision(10, 2);
                
                entity.HasOne(e => e.Order)
                      .WithMany(o => o.Items)
                      .HasForeignKey(e => e.OrderId)
                      .OnDelete(DeleteBehavior.Cascade);
            });

            // é…ç½®ShippingRate
            modelBuilder.Entity<ShippingRate>(entity =>
            {
                entity.Property(e => e.Rate).HasPrecision(10, 2);
                entity.HasIndex(e => e.Province).IsUnique();
            });

            // åˆå§‹åŒ–è¿è´¹æ•°æ®
            modelBuilder.Entity<ShippingRate>().HasData(
                new ShippingRate { Id = 1, Province = "å¹¿ä¸œçœ", Rate = 1.5M },
                new ShippingRate { Id = 2, Province = "åŒ—äº¬å¸‚", Rate = 2.0M },
                new ShippingRate { Id = 3, Province = "ä¸Šæµ·å¸‚", Rate = 2.0M },
                new ShippingRate { Id = 4, Province = "æ±Ÿè‹çœ", Rate = 2.0M },
                new ShippingRate { Id = 5, Province = "æµ™æ±Ÿçœ", Rate = 2.0M },
                new ShippingRate { Id = 6, Province = "default", Rate = 2.5M }
            );
        }
    }
}
```

---

## æ ¸å¿ƒä»£ç å®ç°è¯´æ˜

### 1. å®ä½“æ¨¡å‹ç¤ºä¾‹ï¼ˆProduct.csï¼‰

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace LLXRice.WebApi.Models.Entities
{
    [Table("Products")]
    public class Product
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [MaxLength(100)]
        public string Name { get; set; }

        [Required]
        [Column(TypeName = "decimal(10,2)")]
        public decimal Price { get; set; }

        [Required]
        [MaxLength(20)]
        public string Unit { get; set; }

        [Required]
        [Column(TypeName = "decimal(10,2)")]
        public decimal Weight { get; set; }

        public string Image { get; set; }

        public int Quantity { get; set; } = 0;

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    }
}
```

### 2. æ§åˆ¶å™¨ç¤ºä¾‹ï¼ˆProductsController.csï¼‰

```csharp
using Microsoft.AspNetCore.Mvc;
using LLXRice.WebApi.Models.DTOs;
using LLXRice.WebApi.Services.Interfaces;

namespace LLXRice.WebApi.Controllers
{
    [ApiController]
    [Route("api/v1/[controller]")]
    public class ProductsController : ControllerBase
    {
        private readonly IProductService _productService;
        private readonly ILogger<ProductsController> _logger;

        public ProductsController(
            IProductService productService,
            ILogger<ProductsController> logger)
        {
            _productService = productService;
            _logger = logger;
        }

        /// <summary>
        /// è·å–æ‰€æœ‰å•†å“
        /// </summary>
        [HttpGet]
        public async Task<ActionResult<ApiResponse<List<ProductDto>>>> GetAllProducts()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                return Ok(new ApiResponse<List<ProductDto>>
                {
                    Success = true,
                    Message = "è·å–æˆåŠŸ",
                    Data = products,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "è·å–å•†å“åˆ—è¡¨å¤±è´¥");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
                });
            }
        }

        /// <summary>
        /// æ ¹æ®IDè·å–å•†å“
        /// </summary>
        [HttpGet("{id}")]
        public async Task<ActionResult<ApiResponse<ProductDto>>> GetProductById(int id)
        {
            try
            {
                var product = await _productService.GetProductByIdAsync(id);
                if (product == null)
                {
                    return NotFound(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "å•†å“ä¸å­˜åœ¨"
                    });
                }

                return Ok(new ApiResponse<ProductDto>
                {
                    Success = true,
                    Message = "è·å–æˆåŠŸ",
                    Data = product,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"è·å–å•†å“å¤±è´¥: {id}");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
                });
            }
        }

        /// <summary>
        /// åˆ›å»ºæ–°å•†å“
        /// </summary>
        [HttpPost]
        public async Task<ActionResult<ApiResponse<ProductDto>>> CreateProduct(
            [FromBody] CreateProductDto dto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "è¯·æ±‚å‚æ•°æ— æ•ˆ"
                    });
                }

                var product = await _productService.CreateProductAsync(dto);
                return CreatedAtAction(
                    nameof(GetProductById),
                    new { id = product.Id },
                    new ApiResponse<ProductDto>
                    {
                        Success = true,
                        Message = "åˆ›å»ºæˆåŠŸ",
                        Data = product,
                        Timestamp = DateTime.UtcNow
                    });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ›å»ºå•†å“å¤±è´¥");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
                });
            }
        }

        /// <summary>
        /// æ›´æ–°å•†å“
        /// </summary>
        [HttpPut("{id}")]
        public async Task<ActionResult<ApiResponse<ProductDto>>> UpdateProduct(
            int id,
            [FromBody] UpdateProductDto dto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "è¯·æ±‚å‚æ•°æ— æ•ˆ"
                    });
                }

                var product = await _productService.UpdateProductAsync(id, dto);
                if (product == null)
                {
                    return NotFound(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "å•†å“ä¸å­˜åœ¨"
                    });
                }

                return Ok(new ApiResponse<ProductDto>
                {
                    Success = true,
                    Message = "æ›´æ–°æˆåŠŸ",
                    Data = product,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"æ›´æ–°å•†å“å¤±è´¥: {id}");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
                });
            }
        }

        /// <summary>
        /// åˆ é™¤å•†å“
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<ActionResult<ApiResponse<object>>> DeleteProduct(int id)
        {
            try
            {
                var success = await _productService.DeleteProductAsync(id);
                if (!success)
                {
                    return NotFound(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "å•†å“ä¸å­˜åœ¨"
                    });
                }

                return Ok(new ApiResponse<object>
                {
                    Success = true,
                    Message = "åˆ é™¤æˆåŠŸ",
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"åˆ é™¤å•†å“å¤±è´¥: {id}");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
                });
            }
        }
    }
}
```

### 3. æœåŠ¡å±‚ç¤ºä¾‹ï¼ˆOrderService.cs - æ ¸å¿ƒé€»è¾‘ï¼‰

```csharp
public class OrderService : IOrderService
{
    private readonly IOrderRepository _orderRepository;
    private readonly IProductRepository _productRepository;
    private readonly IAddressRepository _addressRepository;
    private readonly IShippingService _shippingService;

    public async Task<OrderDto> CreateOrderAsync(CreateOrderDto dto)
    {
        // 1. éªŒè¯åœ°å€
        var address = await _addressRepository.GetByIdAsync(dto.AddressId);
        if (address == null)
            throw new Exception("æ”¶è´§åœ°å€ä¸å­˜åœ¨");

        // 2. éªŒè¯å•†å“å¹¶è®¡ç®—ä»·æ ¼
        decimal totalRicePrice = 0;
        decimal totalWeight = 0;
        var orderItems = new List<OrderItem>();

        foreach (var item in dto.Items)
        {
            var product = await _productRepository.GetByIdAsync(item.ProductId);
            if (product == null)
                throw new Exception($"å•†å“ä¸å­˜åœ¨: {item.ProductId}");

            var subtotal = product.Price * item.Quantity;
            var itemWeight = product.Weight * item.Quantity;

            totalRicePrice += subtotal;
            totalWeight += itemWeight;

            orderItems.Add(new OrderItem
            {
                ProductId = product.Id,
                ProductName = product.Name,
                ProductPrice = product.Price,
                ProductUnit = product.Unit,
                ProductWeight = product.Weight,
                Quantity = item.Quantity,
                Subtotal = subtotal
            });
        }

        // 3. è®¡ç®—è¿è´¹
        var shippingInfo = await _shippingService.CalculateShippingAsync(
            address.Province, totalWeight);

        // 4. ç”Ÿæˆè®¢å•å·
        var orderNo = GenerateOrderNumber();

        // 5. åˆ›å»ºè®¢å•
        var order = new Order
        {
            OrderNo = orderNo,
            AddressId = dto.AddressId,
            TotalRicePrice = totalRicePrice,
            TotalWeight = totalWeight,
            ShippingRate = shippingInfo.Rate,
            TotalShipping = shippingInfo.Shipping,
            GrandTotal = totalRicePrice + shippingInfo.Shipping,
            Status = "å¾…å‘è´§",
            Items = orderItems
        };

        // 6. ä¿å­˜è®¢å•
        var created = await _orderRepository.CreateAsync(order);
        
        return MapToDto(created);
    }

    private string GenerateOrderNumber()
    {
        return $"ORD{DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}";
    }
}
```

### 4. åœ°å€è§£æå·¥å…·ï¼ˆAddressParser.csï¼‰

```csharp
using System.Text.RegularExpressions;

namespace LLXRice.WebApi.Utilities
{
    public class AddressParser
    {
        /// <summary>
        /// è§£æåœ°å€æ–‡æœ¬
        /// </summary>
        public static ParsedAddress Parse(string text)
        {
            if (string.IsNullOrWhiteSpace(text))
                return null;

            var result = new ParsedAddress();

            // æ¸…ç†æ–‡æœ¬
            var cleanText = Regex.Replace(text, @"\s+", "");

            // æå–å§“åï¼ˆ2-4ä¸ªæ±‰å­—ï¼‰
            var nameMatch = Regex.Match(cleanText, @"^[\u4e00-\u9fa5]{2,4}(?![ä¸€-é¾¥])");
            if (nameMatch.Success)
            {
                result.Name = nameMatch.Value;
                cleanText = cleanText.Substring(nameMatch.Length);
            }

            // æå–ç”µè¯ï¼ˆ11ä½æ‰‹æœºå·ï¼‰
            var phoneMatch = Regex.Match(cleanText, @"1[3-9]\d{9}");
            if (phoneMatch.Success)
            {
                result.Phone = phoneMatch.Value;
                cleanText = cleanText.Replace(phoneMatch.Value, "");
            }

            // æå–çœå¸‚åŒº
            var provinceMatch = Regex.Match(cleanText, @"([\u4e00-\u9fa5]{2,10}?(?:çœ|è‡ªæ²»åŒº|ç‰¹åˆ«è¡Œæ”¿åŒº))");
            if (provinceMatch.Success)
            {
                result.Province = provinceMatch.Value;
                cleanText = cleanText.Replace(provinceMatch.Value, "");
            }

            var cityMatch = Regex.Match(cleanText, @"([\u4e00-\u9fa5]{2,10}?(?:å¸‚|åœ°åŒº|å·|ç›Ÿ))");
            if (cityMatch.Success)
            {
                result.City = cityMatch.Value;
                cleanText = cleanText.Replace(cityMatch.Value, "");
            }

            var districtMatch = Regex.Match(cleanText, @"([\u4e00-\u9fa5]{2,10}?(?:åŒº|å¿|å¸‚|æ——))");
            if (districtMatch.Success)
            {
                result.District = districtMatch.Value;
                cleanText = cleanText.Replace(districtMatch.Value, "");
            }

            // å‰©ä½™éƒ¨åˆ†ä½œä¸ºè¯¦ç»†åœ°å€
            result.Detail = cleanText.Trim();

            return result;
        }
    }

    public class ParsedAddress
    {
        public string Name { get; set; }
        public string Phone { get; set; }
        public string Province { get; set; }
        public string City { get; set; }
        public string District { get; set; }
        public string Detail { get; set; }
    }
}
```

---

## éƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šWindows Server + IIS éƒ¨ç½²

#### 1. ç¯å¢ƒå‡†å¤‡

```powershell
# å®‰è£… .NET 8 Runtime
# ä¸‹è½½å¹¶å®‰è£…ï¼šhttps://dotnet.microsoft.com/download/dotnet/8.0

# å®‰è£… PostgreSQL 16
# ä¸‹è½½å¹¶å®‰è£…ï¼šhttps://www.postgresql.org/download/windows/

# å®‰è£… IIS
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ASPNET45
```

#### 2. å‘å¸ƒåº”ç”¨

```powershell
# å‘å¸ƒä¸ºç‹¬ç«‹éƒ¨ç½²
dotnet publish -c Release -o ./publish --self-contained false

# æˆ–å‘å¸ƒä¸ºè‡ªåŒ…å«éƒ¨ç½²ï¼ˆåŒ…å«è¿è¡Œæ—¶ï¼‰
dotnet publish -c Release -o ./publish --self-contained true -r win-x64
```

#### 3. IIS é…ç½®

```xml
<!-- web.config -->
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
    </handlers>
    <aspNetCore processPath="dotnet"
                arguments=".\LLXRice.WebApi.dll"
                stdoutLogEnabled="false"
                stdoutLogFile=".\logs\stdout"
                hostingModel="inprocess" />
  </system.webServer>
</configuration>
```

#### 4. æ•°æ®åº“é…ç½®

```sql
-- åœ¨PostgreSQLä¸­åˆ›å»ºæ•°æ®åº“
CREATE DATABASE llxrice;

-- åˆ›å»ºç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
CREATE USER llxrice_user WITH PASSWORD 'strong_password';
GRANT ALL PRIVILEGES ON DATABASE llxrice TO llxrice_user;
```

#### 5. è¿è¡Œè¿ç§»

```powershell
# åœ¨å‘å¸ƒç›®å½•æ‰§è¡Œ
cd ./publish
dotnet LLXRice.WebApi.dll --migrate
# æˆ–æ‰‹åŠ¨æ‰§è¡Œè¿ç§»
dotnet ef database update
```

### æ–¹æ¡ˆäºŒï¼šLinux + Docker éƒ¨ç½²

#### 1. Dockerfile

```dockerfile
# Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["src/LLXRice.WebApi/LLXRice.WebApi.csproj", "LLXRice.WebApi/"]
RUN dotnet restore "LLXRice.WebApi/LLXRice.WebApi.csproj"

COPY src/ .
WORKDIR "/src/LLXRice.WebApi"
RUN dotnet build "LLXRice.WebApi.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "LLXRice.WebApi.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "LLXRice.WebApi.dll"]
```

#### 2. docker-compose.yml

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: llxrice_db
    environment:
      POSTGRES_DB: llxrice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your_strong_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - llxrice_network

  webapi:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: llxrice_api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=llxrice;Username=postgres;Password=your_strong_password
    ports:
      - "8080:80"
      - "8443:443"
    depends_on:
      - postgres
    networks:
      - llxrice_network

volumes:
  postgres_data:

networks:
  llxrice_network:
    driver: bridge
```

#### 3. éƒ¨ç½²å‘½ä»¤

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f webapi

# åœæ­¢æœåŠ¡
docker-compose down

# é‡æ–°æ„å»º
docker-compose up -d --build
```

### æ–¹æ¡ˆä¸‰ï¼šäº‘æœåŠ¡éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### Azure App Service

```bash
# å®‰è£… Azure CLI
# ç™»å½•
az login

# åˆ›å»ºèµ„æºç»„
az group create --name llxrice-rg --location eastasia

# åˆ›å»º PostgreSQL æ•°æ®åº“
az postgres flexible-server create \
  --name llxrice-db \
  --resource-group llxrice-rg \
  --location eastasia \
  --admin-user adminuser \
  --admin-password YourPassword123! \
  --sku-name Standard_B1ms

# åˆ›å»º App Service
az appservice plan create \
  --name llxrice-plan \
  --resource-group llxrice-rg \
  --sku B1 \
  --is-linux

az webapp create \
  --name llxrice-api \
  --resource-group llxrice-rg \
  --plan llxrice-plan \
  --runtime "DOTNETCORE:8.0"

# é…ç½®è¿æ¥å­—ç¬¦ä¸²
az webapp config connection-string set \
  --name llxrice-api \
  --resource-group llxrice-rg \
  --connection-string-type PostgreSQL \
  --settings DefaultConnection="Host=llxrice-db.postgres.database.azure.com;Database=llxrice;Username=adminuser;Password=YourPassword123!"

# éƒ¨ç½²åº”ç”¨
az webapp deployment source config-zip \
  --name llxrice-api \
  --resource-group llxrice-rg \
  --src ./publish.zip
```

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- [ ] CORSç­–ç•¥å·²é…ç½®
- [ ] SSLè¯ä¹¦å·²é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] æ—¥å¿—è®°å½•å·²å¯ç”¨
- [ ] æ€§èƒ½ç›‘æ§å·²é…ç½®
- [ ] å¤‡ä»½ç­–ç•¥å·²è®¾ç½®
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®

---

## å°ç¨‹åºå¯¹æ¥è¯´æ˜

### 1. é…ç½®å°ç¨‹åºåˆæ³•åŸŸå

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸåï¼š
```
requeståˆæ³•åŸŸåï¼šhttps://api.llxrice.com
```

### 2. å°ç¨‹åºHTTPè¯·æ±‚å°è£…

åˆ›å»º `utils/httpClient.js`ï¼š

```javascript
// utils/httpClient.js
const BASE_URL = 'https://api.llxrice.com/api/v1'

class HttpClient {
  /**
   * é€šç”¨è¯·æ±‚æ–¹æ³•
   */
  static request(url, method = 'GET', data = null) {
    return new Promise((resolve, reject) => {
      wx.showLoading({
        title: 'åŠ è½½ä¸­...',
        mask: true
      })

      wx.request({
        url: `${BASE_URL}${url}`,
        method: method,
        data: data,
        header: {
          'Content-Type': 'application/json'
        },
        success: (res) => {
          wx.hideLoading()
          
          if (res.statusCode === 200 && res.data.success) {
            resolve(res.data.data)
          } else {
            wx.showToast({
              title: res.data.message || 'è¯·æ±‚å¤±è´¥',
              icon: 'none'
            })
            reject(res.data)
          }
        },
        fail: (err) => {
          wx.hideLoading()
          wx.showToast({
            title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
            icon: 'none'
          })
          reject(err)
        }
      })
    })
  }

  // GETè¯·æ±‚
  static get(url) {
    return this.request(url, 'GET')
  }

  // POSTè¯·æ±‚
  static post(url, data) {
    return this.request(url, 'POST', data)
  }

  // PUTè¯·æ±‚
  static put(url, data) {
    return this.request(url, 'PUT', data)
  }

  // DELETEè¯·æ±‚
  static delete(url) {
    return this.request(url, 'DELETE')
  }
}

module.exports = HttpClient
```

### 3. APIæœåŠ¡å°è£…

åˆ›å»º `utils/apiService.js`ï¼š

```javascript
// utils/apiService.js
const HttpClient = require('./httpClient.js')

class ApiService {
  // ========== å•†å“ç›¸å…³ ==========
  
  /**
   * è·å–å•†å“åˆ—è¡¨
   */
  static getProducts() {
    return HttpClient.get('/products')
  }

  /**
   * è·å–å•ä¸ªå•†å“
   */
  static getProductById(id) {
    return HttpClient.get(`/products/${id}`)
  }

  /**
   * åˆ›å»ºå•†å“
   */
  static createProduct(data) {
    return HttpClient.post('/products', data)
  }

  /**
   * æ›´æ–°å•†å“
   */
  static updateProduct(id, data) {
    return HttpClient.put(`/products/${id}`, data)
  }

  /**
   * åˆ é™¤å•†å“
   */
  static deleteProduct(id) {
    return HttpClient.delete(`/products/${id}`)
  }

  // ========== åœ°å€ç›¸å…³ ==========
  
  /**
   * è·å–åœ°å€åˆ—è¡¨
   */
  static getAddresses() {
    return HttpClient.get('/addresses')
  }

  /**
   * åˆ›å»ºåœ°å€
   */
  static createAddress(data) {
    return HttpClient.post('/addresses', data)
  }

  /**
   * æ›´æ–°åœ°å€
   */
  static updateAddress(id, data) {
    return HttpClient.put(`/addresses/${id}`, data)
  }

  /**
   * åˆ é™¤åœ°å€
   */
  static deleteAddress(id) {
    return HttpClient.delete(`/addresses/${id}`)
  }

  /**
   * è®¾ç½®é»˜è®¤åœ°å€
   */
  static setDefaultAddress(id) {
    return HttpClient.put(`/addresses/${id}/set-default`)
  }

  /**
   * è§£æåœ°å€æ–‡æœ¬
   */
  static parseAddress(text) {
    return HttpClient.post('/addresses/parse', { text })
  }

  // ========== è®¢å•ç›¸å…³ ==========
  
  /**
   * è·å–è®¢å•åˆ—è¡¨
   */
  static getOrders(page = 1, pageSize = 10, status = null) {
    let url = `/orders?page=${page}&pageSize=${pageSize}`
    if (status) {
      url += `&status=${status}`
    }
    return HttpClient.get(url)
  }

  /**
   * è·å–è®¢å•è¯¦æƒ…
   */
  static getOrderById(id) {
    return HttpClient.get(`/orders/${id}`)
  }

  /**
   * åˆ›å»ºè®¢å•
   */
  static createOrder(data) {
    return HttpClient.post('/orders', data)
  }

  /**
   * æ›´æ–°è®¢å•çŠ¶æ€
   */
  static updateOrderStatus(id, status) {
    return HttpClient.put(`/orders/${id}/status`, { status })
  }

  /**
   * åˆ é™¤è®¢å•
   */
  static deleteOrder(id) {
    return HttpClient.delete(`/orders/${id}`)
  }

  // ========== è¿è´¹ç›¸å…³ ==========
  
  /**
   * è®¡ç®—è¿è´¹
   */
  static calculateShipping(province, weight) {
    return HttpClient.post('/shipping/calculate', { province, weight })
  }

  /**
   * è·å–è¿è´¹é…ç½®
   */
  static getShippingRates() {
    return HttpClient.get('/shipping/rates')
  }
}

module.exports = ApiService
```

### 4. å°ç¨‹åºé¡µé¢æ”¹é€ ç¤ºä¾‹

#### 4.1 ä¿®æ”¹ index.jsï¼ˆå•†å“é¡µé¢ï¼‰

```javascript
// pages/index/index.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    riceProducts: [],
    // ... å…¶ä»–æ•°æ®
  },

  onLoad() {
    // ä»APIåŠ è½½å•†å“æ•°æ®
    this.loadProducts()
  },

  /**
   * ä»APIåŠ è½½å•†å“åˆ—è¡¨
   */
  async loadProducts() {
    try {
      const products = await ApiService.getProducts()
      this.setData({
        riceProducts: products,
        isEmpty: products.length === 0
      })
      console.log('æˆåŠŸä»APIåŠ è½½å•†å“æ•°æ®', products.length, 'ä¸ªå•†å“')
    } catch (error) {
      console.error('åŠ è½½å•†å“å¤±è´¥', error)
      // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
      this.loadLocalData()
    }
  },

  /**
   * æ·»åŠ æ–°å•†å“ï¼ˆä¿å­˜åˆ°APIï¼‰
   */
  async confirmAddRice() {
    const { newRiceName, newRicePrice, newRiceUnit, newRiceWeight, newRiceImage } = this.data

    // éªŒè¯è¾“å…¥...

    try {
      const newProduct = {
        name: newRiceName.trim(),
        price: parseFloat(newRicePrice),
        unit: newRiceUnit,
        weight: parseFloat(newRiceWeight),
        image: newRiceImage,
        quantity: 0
      }

      // è°ƒç”¨APIåˆ›å»ºå•†å“
      const created = await ApiService.createProduct(newProduct)
      
      // é‡æ–°åŠ è½½å•†å“åˆ—è¡¨
      await this.loadProducts()

      this.setData({
        showAddDialog: false
      })

      wx.showToast({
        title: 'æ·»åŠ æˆåŠŸ',
        icon: 'success'
      })
    } catch (error) {
      console.error('æ·»åŠ å•†å“å¤±è´¥', error)
      wx.showToast({
        title: 'æ·»åŠ å¤±è´¥',
        icon: 'none'
      })
    }
  },

  /**
   * åˆ é™¤å•†å“ï¼ˆä»APIåˆ é™¤ï¼‰
   */
  async deleteProduct(e) {
    const { id } = e.currentTarget.dataset
    
    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤§ç±³ç±»å‹å—ï¼Ÿ',
      success: async (res) => {
        if (res.confirm) {
          try {
            await ApiService.deleteProduct(id)
            await this.loadProducts()
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })
          } catch (error) {
            console.error('åˆ é™¤å•†å“å¤±è´¥', error)
            wx.showToast({
              title: 'åˆ é™¤å¤±è´¥',
              icon: 'none'
            })
          }
        }
      }
    })
  }
})
```

#### 4.2 ä¿®æ”¹ checkout.jsï¼ˆç»“ç®—é¡µé¢ï¼‰

```javascript
// pages/checkout/checkout.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    selectedProducts: [],
    selectedAddress: null,
    // ... å…¶ä»–æ•°æ®
  },

  /**
   * ç¡®è®¤ä¸‹å•ï¼ˆè°ƒç”¨APIï¼‰
   */
  async confirmOrder() {
    const { selectedAddress, selectedProducts } = this.data

    if (!selectedAddress) {
      wx.showToast({
        title: 'è¯·å…ˆé€‰æ‹©æ”¶è´§åœ°å€',
        icon: 'none'
      })
      return
    }

    try {
      // å‡†å¤‡è®¢å•æ•°æ®
      const orderData = {
        addressId: selectedAddress.id,
        items: selectedProducts.map(p => ({
          productId: p.id,
          quantity: p.quantity
        }))
      }

      // è°ƒç”¨APIåˆ›å»ºè®¢å•
      const order = await ApiService.createOrder(orderData)

      wx.showToast({
        title: 'ä¸‹å•æˆåŠŸï¼',
        icon: 'success',
        duration: 1500
      })

      // ä¸‹å•æˆåŠŸåçš„å¤„ç†...
      setTimeout(() => {
        wx.reLaunch({
          url: '/pages/index/index'
        })
      }, 1500)
    } catch (error) {
      console.error('åˆ›å»ºè®¢å•å¤±è´¥', error)
      wx.showToast({
        title: 'ä¸‹å•å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
    }
  }
})
```

#### 4.3 ä¿®æ”¹ orders.jsï¼ˆè®¢å•é¡µé¢ï¼‰

```javascript
// pages/orders/orders.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    orderList: [],
    page: 1,
    pageSize: 10,
    total: 0
  },

  onShow() {
    this.loadOrders()
  },

  /**
   * ä»APIåŠ è½½è®¢å•åˆ—è¡¨
   */
  async loadOrders() {
    try {
      const result = await ApiService.getOrders(this.data.page, this.data.pageSize)
      this.setData({
        orderList: result.items,
        total: result.total
      })
      console.log('åŠ è½½è®¢å•', result.items.length, 'ä¸ª')
    } catch (error) {
      console.error('åŠ è½½è®¢å•å¤±è´¥', error)
      // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
      this.loadLocalOrders()
    }
  },

  /**
   * åˆ é™¤è®¢å•ï¼ˆä»APIåˆ é™¤ï¼‰
   */
  async deleteOrder(e) {
    const { orderid } = e.currentTarget.dataset
    
    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿ',
      success: async (res) => {
        if (res.confirm) {
          try {
            await ApiService.deleteOrder(orderid)
            await this.loadOrders()
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })
          } catch (error) {
            console.error('åˆ é™¤è®¢å•å¤±è´¥', error)
            wx.showToast({
              title: 'åˆ é™¤å¤±è´¥',
              icon: 'none'
            })
          }
        }
      }
    })
  }
})
```

#### 4.4 ä¿®æ”¹ address.jsï¼ˆåœ°å€é¡µé¢ï¼‰

```javascript
// pages/address/address.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    addressList: [],
    // ... å…¶ä»–æ•°æ®
  },

  onLoad(options) {
    this.loadAddressList()
  },

  /**
   * ä»APIåŠ è½½åœ°å€åˆ—è¡¨
   */
  async loadAddressList() {
    try {
      const addresses = await ApiService.getAddresses()
      this.setData({
        addressList: addresses
      })
      console.log('åŠ è½½åœ°å€åˆ—è¡¨', addresses.length, 'ä¸ªåœ°å€')
    } catch (error) {
      console.error('åŠ è½½åœ°å€åˆ—è¡¨å¤±è´¥', error)
      // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
      this.loadLocalAddresses()
    }
  },

  /**
   * æ™ºèƒ½è¯†åˆ«åœ°å€ï¼ˆè°ƒç”¨APIï¼‰
   */
  async parseAddressText() {
    const { pasteText } = this.data
    
    if (!pasteText.trim()) {
      wx.showToast({
        title: 'è¯·è¾“å…¥åœ°å€ä¿¡æ¯',
        icon: 'none'
      })
      return
    }

    try {
      const result = await ApiService.parseAddress(pasteText)
      
      // å¡«å……è¡¨å•
      this.setData({
        formName: result.name || '',
        formPhone: result.phone || '',
        formProvince: result.province || '',
        formCity: result.city || '',
        formDistrict: result.district || '',
        formDetail: result.detail || '',
        showPasteDialog: false
      })

      wx.showToast({
        title: 'è¯†åˆ«æˆåŠŸ',
        icon: 'success'
      })
    } catch (error) {
      console.error('åœ°å€è¯†åˆ«å¤±è´¥', error)
      wx.showToast({
        title: 'è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥',
        icon: 'none'
      })
    }
  },

  /**
   * ä¿å­˜åœ°å€ï¼ˆåˆ°APIï¼‰
   */
  async saveAddress() {
    const {
      formName, formPhone, formProvince, formCity,
      formDistrict, formDetail, formIsDefault,
      editingAddress
    } = this.data

    // éªŒè¯è¾“å…¥...

    try {
      const addressData = {
        name: formName.trim(),
        phone: formPhone.trim(),
        province: formProvince.trim(),
        city: formCity.trim(),
        district: formDistrict.trim(),
        detail: formDetail.trim(),
        isDefault: formIsDefault
      }

      if (editingAddress) {
        // æ›´æ–°åœ°å€
        await ApiService.updateAddress(editingAddress.id, addressData)
      } else {
        // åˆ›å»ºåœ°å€
        await ApiService.createAddress(addressData)
      }

      await this.loadAddressList()

      this.setData({
        showEditDialog: false
      })

      wx.showToast({
        title: editingAddress ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ',
        icon: 'success'
      })
    } catch (error) {
      console.error('ä¿å­˜åœ°å€å¤±è´¥', error)
      wx.showToast({
        title: 'ä¿å­˜å¤±è´¥',
        icon: 'none'
      })
    }
  },

  /**
   * åˆ é™¤åœ°å€ï¼ˆä»APIåˆ é™¤ï¼‰
   */
  async deleteAddress(e) {
    const { id } = e.currentTarget.dataset
    
    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°å€å—ï¼Ÿ',
      success: async (res) => {
        if (res.confirm) {
          try {
            await ApiService.deleteAddress(id)
            await this.loadAddressList()
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })
          } catch (error) {
            console.error('åˆ é™¤åœ°å€å¤±è´¥', error)
            wx.showToast({
              title: 'åˆ é™¤å¤±è´¥',
              icon: 'none'
            })
          }
        }
      }
    })
  }
})
```

### 5. æ•°æ®åŒæ­¥ç­–ç•¥

#### ç¦»çº¿ä¼˜å…ˆç­–ç•¥

```javascript
// utils/syncManager.js
class SyncManager {
  /**
   * åŠ è½½æ•°æ®ï¼ˆä¼˜å…ˆAPIï¼Œé™çº§æœ¬åœ°ï¼‰
   */
  static async loadData(apiMethod, localStorageKey) {
    try {
      // å°è¯•ä»APIåŠ è½½
      const data = await apiMethod()
      // ç¼“å­˜åˆ°æœ¬åœ°
      wx.setStorageSync(localStorageKey, data)
      return data
    } catch (error) {
      console.error('APIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜', error)
      // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
      return wx.getStorageSync(localStorageKey) || []
    }
  }

  /**
   * ä¿å­˜æ•°æ®ï¼ˆä¼˜å…ˆAPIï¼Œé™çº§æœ¬åœ°ï¼‰
   */
  static async saveData(apiMethod, localStorageKey, data) {
    try {
      // å°è¯•ä¿å­˜åˆ°API
      const result = await apiMethod(data)
      // åŒæ­¥åˆ°æœ¬åœ°
      const localData = wx.getStorageSync(localStorageKey) || []
      localData.push(result)
      wx.setStorageSync(localStorageKey, localData)
      return result
    } catch (error) {
      console.error('APIä¿å­˜å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°', error)
      // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
      const localData = wx.getStorageSync(localStorageKey) || []
      localData.push(data)
      wx.setStorageSync(localStorageKey, localData)
      throw error
    }
  }
}

module.exports = SyncManager
```

---

## å¼€å‘æ­¥éª¤

### é˜¶æ®µä¸€ï¼šé¡¹ç›®åˆå§‹åŒ–ï¼ˆç¬¬1-2å¤©ï¼‰

1. **åˆ›å»ºé¡¹ç›®**
   ```bash
   dotnet new webapi -n LLXRice.WebApi
   cd LLXRice.WebApi
   ```

2. **å®‰è£…ä¾èµ–åŒ…**
   ```bash
   dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL
   dotnet add package Microsoft.EntityFrameworkCore.Tools
   dotnet add package Microsoft.EntityFrameworkCore.Design
   dotnet add package Swashbuckle.AspNetCore
   dotnet add package AutoMapper.Extensions.Microsoft.DependencyInjection
   ```

3. **é…ç½®æ•°æ®åº“è¿æ¥**
   - ä¿®æ”¹ `appsettings.json`
   - åˆ›å»º `ApplicationDbContext`

4. **åˆ›å»ºå®ä½“æ¨¡å‹**
   - Product, Address, Order, OrderItem, ShippingRate

### é˜¶æ®µäºŒï¼šæ•°æ®è®¿é—®å±‚ï¼ˆç¬¬3-4å¤©ï¼‰

1. **åˆ›å»ºä»“å‚¨æ¥å£**
   - IProductRepository
   - IAddressRepository
   - IOrderRepository
   - IShippingRateRepository

2. **å®ç°ä»“å‚¨ç±»**
   - å®ç°CRUDæ“ä½œ
   - æ·»åŠ æŸ¥è¯¢æ–¹æ³•

3. **æ•°æ®åº“è¿ç§»**
   ```bash
   dotnet ef migrations add InitialCreate
   dotnet ef database update
   ```

### é˜¶æ®µä¸‰ï¼šä¸šåŠ¡é€»è¾‘å±‚ï¼ˆç¬¬5-6å¤©ï¼‰

1. **åˆ›å»ºæœåŠ¡æ¥å£**
   - IProductService
   - IAddressService
   - IOrderService
   - IShippingService

2. **å®ç°æœåŠ¡ç±»**
   - å®ç°ä¸šåŠ¡é€»è¾‘
   - æ·»åŠ æ•°æ®éªŒè¯
   - å®ç°åœ°å€è§£æ

### é˜¶æ®µå››ï¼šAPIæ§åˆ¶å™¨ï¼ˆç¬¬7-8å¤©ï¼‰

1. **åˆ›å»ºæ§åˆ¶å™¨**
   - ProductsController
   - AddressesController
   - OrdersController
   - ShippingController

2. **é…ç½®Swagger**
   - æ·»åŠ APIæ–‡æ¡£æ³¨é‡Š
   - é…ç½®è¯·æ±‚/å“åº”ç¤ºä¾‹

3. **æµ‹è¯•API**
   - ä½¿ç”¨Postmanæµ‹è¯•æ‰€æœ‰æ¥å£

### é˜¶æ®µäº”ï¼šå°ç¨‹åºå¯¹æ¥ï¼ˆç¬¬9-10å¤©ï¼‰

1. **åˆ›å»ºHTTPå®¢æˆ·ç«¯**
   - httpClient.js
   - apiService.js

2. **æ”¹é€ å°ç¨‹åºé¡µé¢**
   - index.js
   - checkout.js
   - orders.js
   - address.js

3. **æµ‹è¯•å¯¹æ¥**
   - æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
   - éªŒè¯æ•°æ®åŒæ­¥

### é˜¶æ®µå…­ï¼šéƒ¨ç½²ä¸Šçº¿ï¼ˆç¬¬11-12å¤©ï¼‰

1. **å‡†å¤‡ç”Ÿäº§ç¯å¢ƒ**
   - é…ç½®æœåŠ¡å™¨
   - å®‰è£…PostgreSQL
   - é…ç½®SSLè¯ä¹¦

2. **éƒ¨ç½²åº”ç”¨**
   - å‘å¸ƒåº”ç”¨
   - é…ç½®IIS/Docker
   - è¿è¡Œæ•°æ®åº“è¿ç§»

3. **é…ç½®å°ç¨‹åº**
   - é…ç½®æœåŠ¡å™¨åŸŸå
   - æäº¤å®¡æ ¸

4. **æµ‹è¯•éªŒè¯**
   - åŠŸèƒ½æµ‹è¯•
   - æ€§èƒ½æµ‹è¯•
   - å‹åŠ›æµ‹è¯•

---

## é™„å½•

### A. NuGetåŒ…æ¸…å•

```xml
<ItemGroup>
  <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.0" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0" />
  <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.0" />
  <PackageReference Include="AutoMapper.Extensions.Microsoft.DependencyInjection" Version="12.0.0" />
  <PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
  <PackageReference Include="Serilog.AspNetCore" Version="8.0.0" />
</ItemGroup>
```

### B. å¸¸ç”¨EF Coreå‘½ä»¤

```bash
# åˆ›å»ºè¿ç§»
dotnet ef migrations add MigrationName

# åº”ç”¨è¿ç§»
dotnet ef database update

# å›æ»šè¿ç§»
dotnet ef database update PreviousMigrationName

# åˆ é™¤è¿ç§»
dotnet ef migrations remove

# ç”ŸæˆSQLè„šæœ¬
dotnet ef migrations script

# æŸ¥çœ‹è¿ç§»åˆ—è¡¨
dotnet ef migrations list
```

### C. PostgreSQLå¸¸ç”¨å‘½ä»¤

```sql
-- æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“
\l

-- è¿æ¥æ•°æ®åº“
\c llxrice

-- æŸ¥çœ‹æ‰€æœ‰è¡¨
\dt

-- æŸ¥çœ‹è¡¨ç»“æ„
\d "Products"

-- æŸ¥çœ‹è¡¨æ•°æ®
SELECT * FROM "Products";

-- å¤‡ä»½æ•°æ®åº“
pg_dump llxrice > backup.sql

-- æ¢å¤æ•°æ®åº“
psql llxrice < backup.sql
```

### D. å¼€å‘å·¥å…·æ¨è

- **IDE**: Visual Studio 2022 / VS Code
- **æ•°æ®åº“å·¥å…·**: pgAdmin 4 / DBeaver
- **APIæµ‹è¯•**: Postman / Swagger UI
- **ç‰ˆæœ¬æ§åˆ¶**: Git / GitHub
- **å®¹å™¨åŒ–**: Docker Desktop
- **æ—¥å¿—æŸ¥çœ‹**: Seq / ELK Stack

---

## æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„åç«¯æœåŠ¡æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š

âœ… **æ•°æ®åº“è®¾è®¡**ï¼šPostgreSQLæ•°æ®åº“è¡¨ç»“æ„è®¾è®¡å®Œæ•´
âœ… **APIè®¾è®¡**ï¼šRESTful APIæ¥å£è®¾è®¡è§„èŒƒ
âœ… **æŠ€æœ¯å®ç°**ï¼š.NET 8 Web API + EF Core + PostgreSQL
âœ… **éƒ¨ç½²æ–¹æ¡ˆ**ï¼šæä¾›Windows/Linux/Docker/äº‘æœåŠ¡å¤šç§éƒ¨ç½²æ–¹æ¡ˆ
âœ… **å°ç¨‹åºå¯¹æ¥**ï¼šè¯¦ç»†çš„å¯¹æ¥æ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹
âœ… **å¼€å‘æ­¥éª¤**ï¼šæ¸…æ™°çš„12å¤©å¼€å‘è®¡åˆ’

è¯¥æ–¹æ¡ˆå¯ä»¥ç›´æ¥ç”¨äºé¡¹ç›®å¼€å‘ï¼Œæ‰€æœ‰æ¥å£éƒ½å·²è®¾è®¡å®Œæ•´ï¼Œæ•°æ®åº“ç»“æ„æ¸…æ™°ï¼Œéƒ¨ç½²æ–¹æ¡ˆå¯è¡Œã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025å¹´10æœˆ16æ—¥  
**é€‚ç”¨ç‰ˆæœ¬**ï¼š.NET 8 + PostgreSQL 16  
**ç»´æŠ¤çŠ¶æ€**ï¼šâœ… å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

---

Â© 2025 æ—é¾é¦™å¤§ç±³å•†åŸåç«¯æœåŠ¡è®¾è®¡æ–¹æ¡ˆ

