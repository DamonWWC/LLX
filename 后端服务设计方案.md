# 林龍香大米商城 - 后端服务完整设计方案

## 📋 目录

1. [系统架构设计](#系统架构设计)
2. [数据库设计](#数据库设计)
3. [API接口设计](#api接口设计)
4. [数据传输对象(DTO)设计](#数据传输对象dto设计)
5. [.NET项目结构](#net项目结构)
6. [核心代码实现说明](#核心代码实现说明)
7. [部署方案](#部署方案)
8. [小程序对接说明](#小程序对接说明)
9. [开发步骤](#开发步骤)

---

## 系统架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        微信小程序客户端                       │
│    (pages/index, checkout, orders, address, shipping)        │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTPS
                       │ RESTful API
┌──────────────────────▼──────────────────────────────────────┐
│                    .NET 8 Web API 层                         │
│  ┌──────────────┬──────────────┬──────────────────────────┐ │
│  │ Controllers  │  Services    │  Repositories            │ │
│  │  (API端点)   │  (业务逻辑)  │  (数据访问)              │ │
│  └──────────────┴──────────────┴──────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │ Entity Framework Core
┌──────────────────────▼──────────────────────────────────────┐
│                  PostgreSQL 数据库                           │
│  ┌──────────┬──────────┬──────────┬────────────────────┐   │
│  │ Products │ Orders   │ Addresses│ OrderItems         │   │
│  └──────────┴──────────┴──────────┴────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈

- **后端框架**：.NET 8 Web API
- **ORM**：Entity Framework Core 8
- **数据库**：PostgreSQL 16
- **开发工具**：Visual Studio 2022 / VS Code
- **API文档**：Swagger / OpenAPI
- **部署平台**：IIS / Docker / Linux

---

## 数据库设计

### 数据库 ER 图

```
┌─────────────────┐         ┌─────────────────┐
│   Products      │         │   Addresses     │
│─────────────────│         │─────────────────│
│ Id (PK)         │         │ Id (PK)         │
│ Name            │         │ Name            │
│ Price           │         │ Phone           │
│ Unit            │         │ Province        │
│ Weight          │         │ City            │
│ Image           │         │ District        │
│ Quantity        │         │ Detail          │
│ CreatedAt       │         │ IsDefault       │
│ UpdatedAt       │         │ CreatedAt       │
└─────────────────┘         │ UpdatedAt       │
                            └─────────────────┘
        │                             │
        │                             │
        │   ┌─────────────────┐      │
        └───│   Orders        │──────┘
            │─────────────────│
            │ Id (PK)         │
            │ OrderNo         │
            │ AddressId (FK)  │
            │ TotalRicePrice  │
            │ TotalWeight     │
            │ ShippingRate    │
            │ TotalShipping   │
            │ GrandTotal      │
            │ Status          │
            │ CreatedAt       │
            └────────┬────────┘
                     │
                     │ 1:N
            ┌────────▼────────┐
            │   OrderItems    │
            │─────────────────│
            │ Id (PK)         │
            │ OrderId (FK)    │
            │ ProductId (FK)  │
            │ ProductName     │
            │ ProductPrice    │
            │ ProductUnit     │
            │ ProductWeight   │
            │ Quantity        │
            │ Subtotal        │
            └─────────────────┘
```

### PostgreSQL 表结构

#### 1. Products（商品表）

```sql
CREATE TABLE "Products" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(100) NOT NULL,
    "Price" DECIMAL(10,2) NOT NULL,
    "Unit" VARCHAR(20) NOT NULL,            -- 袋/箱
    "Weight" DECIMAL(10,2) NOT NULL,        -- 单位重量（斤）
    "Image" TEXT,                           -- Base64或图片URL
    "Quantity" INT DEFAULT 0,               -- 默认库存数量
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX "idx_products_name" ON "Products"("Name");
```

#### 2. Addresses（收货地址表）

```sql
CREATE TABLE "Addresses" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(50) NOT NULL,            -- 收货人姓名
    "Phone" VARCHAR(20) NOT NULL,           -- 联系电话
    "Province" VARCHAR(50) NOT NULL,        -- 省份
    "City" VARCHAR(50) NOT NULL,            -- 城市
    "District" VARCHAR(50),                 -- 区县
    "Detail" VARCHAR(200) NOT NULL,         -- 详细地址
    "IsDefault" BOOLEAN DEFAULT FALSE,      -- 是否默认地址
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX "idx_addresses_default" ON "Addresses"("IsDefault");
CREATE INDEX "idx_addresses_phone" ON "Addresses"("Phone");
```

#### 3. Orders（订单表）

```sql
CREATE TABLE "Orders" (
    "Id" SERIAL PRIMARY KEY,
    "OrderNo" VARCHAR(50) UNIQUE NOT NULL,  -- 订单号
    "AddressId" INT NOT NULL,               -- 收货地址ID
    "TotalRicePrice" DECIMAL(10,2) NOT NULL,-- 商品总价
    "TotalWeight" DECIMAL(10,2) NOT NULL,   -- 总重量（斤）
    "ShippingRate" DECIMAL(10,2) NOT NULL,  -- 运费单价（元/斤）
    "TotalShipping" DECIMAL(10,2) NOT NULL, -- 运费总计
    "GrandTotal" DECIMAL(10,2) NOT NULL,    -- 订单总金额
    "Status" VARCHAR(20) NOT NULL DEFAULT '待发货', -- 订单状态
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT "fk_orders_address" FOREIGN KEY ("AddressId") 
        REFERENCES "Addresses"("Id") ON DELETE RESTRICT
);

CREATE INDEX "idx_orders_orderno" ON "Orders"("OrderNo");
CREATE INDEX "idx_orders_status" ON "Orders"("Status");
CREATE INDEX "idx_orders_createdat" ON "Orders"("CreatedAt" DESC);
```

#### 4. OrderItems（订单明细表）

```sql
CREATE TABLE "OrderItems" (
    "Id" SERIAL PRIMARY KEY,
    "OrderId" INT NOT NULL,                 -- 订单ID
    "ProductId" INT NOT NULL,               -- 商品ID
    "ProductName" VARCHAR(100) NOT NULL,    -- 商品名称（冗余存储）
    "ProductPrice" DECIMAL(10,2) NOT NULL,  -- 商品单价（冗余存储）
    "ProductUnit" VARCHAR(20) NOT NULL,     -- 商品单位（冗余存储）
    "ProductWeight" DECIMAL(10,2) NOT NULL, -- 商品重量（冗余存储）
    "Quantity" INT NOT NULL,                -- 购买数量
    "Subtotal" DECIMAL(10,2) NOT NULL,      -- 小计
    
    CONSTRAINT "fk_orderitems_order" FOREIGN KEY ("OrderId") 
        REFERENCES "Orders"("Id") ON DELETE CASCADE,
    CONSTRAINT "fk_orderitems_product" FOREIGN KEY ("ProductId") 
        REFERENCES "Products"("Id") ON DELETE RESTRICT
);

CREATE INDEX "idx_orderitems_orderid" ON "OrderItems"("OrderId");
CREATE INDEX "idx_orderitems_productid" ON "OrderItems"("ProductId");
```

#### 5. ShippingRates（运费配置表）

```sql
CREATE TABLE "ShippingRates" (
    "Id" SERIAL PRIMARY KEY,
    "Province" VARCHAR(50) NOT NULL UNIQUE, -- 省份名称
    "Rate" DECIMAL(10,2) NOT NULL,          -- 运费单价（元/斤）
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初始化运费数据
INSERT INTO "ShippingRates" ("Province", "Rate") VALUES
('广东省', 1.5),
('北京市', 2.0),
('上海市', 2.0),
('江苏省', 2.0),
('浙江省', 2.0),
('default', 2.5);  -- 默认运费
```

---

## API接口设计

### API基础信息

- **Base URL**: `https://api.llxrice.com/api/v1`
- **数据格式**: JSON
- **字符编码**: UTF-8
- **时间格式**: ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ)

### 统一响应格式

```json
{
  "success": true,
  "message": "操作成功",
  "data": {},
  "timestamp": "2025-10-16T10:30:00.000Z"
}
```

### 1. 商品管理接口（Products）

#### 1.1 获取商品列表

```
GET /products
```

**响应示例**：
```json
{
  "success": true,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "name": "稻花香",
      "price": 40.00,
      "unit": "袋",
      "weight": 10.00,
      "image": "data:image/svg+xml,...",
      "quantity": 0,
      "createdAt": "2025-10-16T10:00:00Z",
      "updatedAt": "2025-10-16T10:00:00Z"
    }
  ]
}
```

#### 1.2 获取单个商品

```
GET /products/{id}
```

#### 1.3 创建商品

```
POST /products
Content-Type: application/json

{
  "name": "稻花香",
  "price": 40.00,
  "unit": "袋",
  "weight": 10.00,
  "image": "data:image/svg+xml,...",
  "quantity": 0
}
```

#### 1.4 更新商品

```
PUT /products/{id}
Content-Type: application/json

{
  "name": "稻花香",
  "price": 45.00,
  "unit": "袋",
  "weight": 10.00,
  "image": "data:image/svg+xml,...",
  "quantity": 0
}
```

#### 1.5 删除商品

```
DELETE /products/{id}
```

### 2. 地址管理接口（Addresses）

#### 2.1 获取地址列表

```
GET /addresses
```

**响应示例**：
```json
{
  "success": true,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "name": "张三",
      "phone": "13800138000",
      "province": "广东省",
      "city": "深圳市",
      "district": "南山区",
      "detail": "科技园南路1号",
      "isDefault": true,
      "createdAt": "2025-10-16T10:00:00Z",
      "updatedAt": "2025-10-16T10:00:00Z"
    }
  ]
}
```

#### 2.2 获取单个地址

```
GET /addresses/{id}
```

#### 2.3 创建地址

```
POST /addresses
Content-Type: application/json

{
  "name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "detail": "科技园南路1号",
  "isDefault": true
}
```

#### 2.4 更新地址

```
PUT /addresses/{id}
```

#### 2.5 删除地址

```
DELETE /addresses/{id}
```

#### 2.6 设置默认地址

```
PUT /addresses/{id}/set-default
```

#### 2.7 地址智能识别

```
POST /addresses/parse
Content-Type: application/json

{
  "text": "张三 13800138000 广东省深圳市南山区科技园南路1号"
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "识别成功",
  "data": {
    "name": "张三",
    "phone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detail": "科技园南路1号"
  }
}
```

### 3. 订单管理接口（Orders）

#### 3.1 获取订单列表

```
GET /orders?page=1&pageSize=10&status=待发货
```

**查询参数**：
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认10）
- `status`: 订单状态（可选）

**响应示例**：
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "items": [
      {
        "id": 1,
        "orderNo": "ORD1729123456789",
        "address": {
          "id": 1,
          "name": "张三",
          "phone": "13800138000",
          "province": "广东省",
          "city": "深圳市",
          "district": "南山区",
          "detail": "科技园南路1号"
        },
        "items": [
          {
            "id": 1,
            "productId": 1,
            "productName": "稻花香",
            "productPrice": 40.00,
            "productUnit": "袋",
            "productWeight": 10.00,
            "quantity": 2,
            "subtotal": 80.00
          }
        ],
        "totalRicePrice": 80.00,
        "totalWeight": 20.00,
        "shippingRate": 1.50,
        "totalShipping": 30.00,
        "grandTotal": 110.00,
        "status": "待发货",
        "createdAt": "2025-10-16T10:00:00Z",
        "updatedAt": "2025-10-16T10:00:00Z"
      }
    ]
  }
}
```

#### 3.2 获取订单详情

```
GET /orders/{id}
```

#### 3.3 创建订单

```
POST /orders
Content-Type: application/json

{
  "addressId": 1,
  "items": [
    {
      "productId": 1,
      "quantity": 2
    },
    {
      "productId": 2,
      "quantity": 1
    }
  ]
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "订单创建成功",
  "data": {
    "id": 1,
    "orderNo": "ORD1729123456789",
    "grandTotal": 110.00
  }
}
```

#### 3.4 更新订单状态

```
PUT /orders/{id}/status
Content-Type: application/json

{
  "status": "已发货"
}
```

#### 3.5 删除订单

```
DELETE /orders/{id}
```

#### 3.6 批量删除订单

```
DELETE /orders/batch
Content-Type: application/json

{
  "orderIds": [1, 2, 3]
}
```

### 4. 运费计算接口（Shipping）

#### 4.1 计算运费

```
POST /shipping/calculate
Content-Type: application/json

{
  "province": "广东省",
  "weight": 20.00
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "计算成功",
  "data": {
    "province": "广东省",
    "weight": 20.00,
    "rate": 1.50,
    "shipping": 30.00
  }
}
```

#### 4.2 获取运费配置

```
GET /shipping/rates
```

#### 4.3 更新运费配置

```
PUT /shipping/rates/{province}
Content-Type: application/json

{
  "rate": 1.80
}
```

---

## 数据传输对象(DTO)设计

### Product DTOs

```csharp
// 创建商品DTO
public class CreateProductDto
{
    [Required]
    [MaxLength(100)]
    public string Name { get; set; }
    
    [Required]
    [Range(0.01, 999999.99)]
    public decimal Price { get; set; }
    
    [Required]
    [MaxLength(20)]
    public string Unit { get; set; }
    
    [Required]
    [Range(0.01, 999999.99)]
    public decimal Weight { get; set; }
    
    public string Image { get; set; }
    
    [Range(0, 999999)]
    public int Quantity { get; set; } = 0;
}

// 更新商品DTO
public class UpdateProductDto : CreateProductDto { }

// 商品响应DTO
public class ProductDto
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public string Unit { get; set; }
    public decimal Weight { get; set; }
    public string Image { get; set; }
    public int Quantity { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### Address DTOs

```csharp
// 创建地址DTO
public class CreateAddressDto
{
    [Required]
    [MaxLength(50)]
    public string Name { get; set; }
    
    [Required]
    [Phone]
    [MaxLength(20)]
    public string Phone { get; set; }
    
    [Required]
    [MaxLength(50)]
    public string Province { get; set; }
    
    [Required]
    [MaxLength(50)]
    public string City { get; set; }
    
    [MaxLength(50)]
    public string District { get; set; }
    
    [Required]
    [MaxLength(200)]
    public string Detail { get; set; }
    
    public bool IsDefault { get; set; } = false;
}

// 地址解析请求DTO
public class ParseAddressDto
{
    [Required]
    public string Text { get; set; }
}

// 地址响应DTO
public class AddressDto
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Phone { get; set; }
    public string Province { get; set; }
    public string City { get; set; }
    public string District { get; set; }
    public string Detail { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### Order DTOs

```csharp
// 订单明细项DTO
public class OrderItemDto
{
    public int Id { get; set; }
    public int ProductId { get; set; }
    public string ProductName { get; set; }
    public decimal ProductPrice { get; set; }
    public string ProductUnit { get; set; }
    public decimal ProductWeight { get; set; }
    public int Quantity { get; set; }
    public decimal Subtotal { get; set; }
}

// 创建订单项DTO
public class CreateOrderItemDto
{
    [Required]
    public int ProductId { get; set; }
    
    [Required]
    [Range(1, 999999)]
    public int Quantity { get; set; }
}

// 创建订单DTO
public class CreateOrderDto
{
    [Required]
    public int AddressId { get; set; }
    
    [Required]
    [MinLength(1)]
    public List<CreateOrderItemDto> Items { get; set; }
}

// 订单响应DTO
public class OrderDto
{
    public int Id { get; set; }
    public string OrderNo { get; set; }
    public AddressDto Address { get; set; }
    public List<OrderItemDto> Items { get; set; }
    public decimal TotalRicePrice { get; set; }
    public decimal TotalWeight { get; set; }
    public decimal ShippingRate { get; set; }
    public decimal TotalShipping { get; set; }
    public decimal GrandTotal { get; set; }
    public string Status { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// 订单列表项DTO（简化版）
public class OrderListItemDto
{
    public int Id { get; set; }
    public string OrderNo { get; set; }
    public string AddressName { get; set; }
    public string AddressPhone { get; set; }
    public int ItemCount { get; set; }
    public decimal GrandTotal { get; set; }
    public string Status { get; set; }
    public DateTime CreatedAt { get; set; }
}

// 分页结果DTO
public class PagedResultDto<T>
{
    public int Total { get; set; }
    public int Page { get; set; }
    public int PageSize { get; set; }
    public List<T> Items { get; set; }
}
```

---

## .NET项目结构

```
LLXRice.WebApi/
├── LLXRice.WebApi.sln                  # 解决方案文件
├── src/
│   ├── LLXRice.WebApi/                 # Web API 项目
│   │   ├── Controllers/
│   │   │   ├── ProductsController.cs
│   │   │   ├── AddressesController.cs
│   │   │   ├── OrdersController.cs
│   │   │   └── ShippingController.cs
│   │   ├── Models/                     # 数据模型
│   │   │   ├── Entities/
│   │   │   │   ├── Product.cs
│   │   │   │   ├── Address.cs
│   │   │   │   ├── Order.cs
│   │   │   │   ├── OrderItem.cs
│   │   │   │   └── ShippingRate.cs
│   │   │   └── DTOs/                   # 数据传输对象
│   │   │       ├── ProductDtos.cs
│   │   │       ├── AddressDtos.cs
│   │   │       ├── OrderDtos.cs
│   │   │       └── ApiResponse.cs
│   │   ├── Services/                   # 业务逻辑层
│   │   │   ├── Interfaces/
│   │   │   │   ├── IProductService.cs
│   │   │   │   ├── IAddressService.cs
│   │   │   │   ├── IOrderService.cs
│   │   │   │   └── IShippingService.cs
│   │   │   └── Implementations/
│   │   │       ├── ProductService.cs
│   │   │       ├── AddressService.cs
│   │   │       ├── OrderService.cs
│   │   │       └── ShippingService.cs
│   │   ├── Repositories/               # 数据访问层
│   │   │   ├── Interfaces/
│   │   │   │   ├── IProductRepository.cs
│   │   │   │   ├── IAddressRepository.cs
│   │   │   │   ├── IOrderRepository.cs
│   │   │   │   └── IShippingRateRepository.cs
│   │   │   └── Implementations/
│   │   │       ├── ProductRepository.cs
│   │   │       ├── AddressRepository.cs
│   │   │       ├── OrderRepository.cs
│   │   │       └── ShippingRateRepository.cs
│   │   ├── Data/
│   │   │   ├── ApplicationDbContext.cs # EF Core DbContext
│   │   │   └── Migrations/             # 数据库迁移
│   │   ├── Utilities/
│   │   │   ├── AddressParser.cs        # 地址解析工具
│   │   │   └── OrderNumberGenerator.cs # 订单号生成器
│   │   ├── Middleware/
│   │   │   ├── ExceptionMiddleware.cs  # 全局异常处理
│   │   │   └── LoggingMiddleware.cs    # 请求日志
│   │   ├── appsettings.json
│   │   ├── appsettings.Development.json
│   │   ├── Program.cs
│   │   └── LLXRice.WebApi.csproj
│   └── LLXRice.Tests/                  # 单元测试项目
│       ├── Controllers/
│       ├── Services/
│       └── LLXRice.Tests.csproj
├── docs/
│   └── API文档.md
└── README.md
```

### 关键文件说明

#### Program.cs（应用程序入口）

```csharp
using Microsoft.EntityFrameworkCore;
using LLXRice.WebApi.Data;
using LLXRice.WebApi.Services.Interfaces;
using LLXRice.WebApi.Services.Implementations;
using LLXRice.WebApi.Repositories.Interfaces;
using LLXRice.WebApi.Repositories.Implementations;

var builder = WebApplication.CreateBuilder(args);

// 添加服务到容器
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// 配置数据库
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection")));

// 配置CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});

// 注册仓储
builder.Services.AddScoped<IProductRepository, ProductRepository>();
builder.Services.AddScoped<IAddressRepository, AddressRepository>();
builder.Services.AddScoped<IOrderRepository, OrderRepository>();
builder.Services.AddScoped<IShippingRateRepository, ShippingRateRepository>();

// 注册服务
builder.Services.AddScoped<IProductService, ProductService>();
builder.Services.AddScoped<IAddressService, AddressService>();
builder.Services.AddScoped<IOrderService, OrderService>();
builder.Services.AddScoped<IShippingService, ShippingService>();

// 配置AutoMapper（如果使用）
builder.Services.AddAutoMapper(typeof(Program));

var app = builder.Build();

// 配置HTTP请求管道
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseCors("AllowAll");
app.UseAuthorization();
app.MapControllers();

app.Run();
```

#### appsettings.json

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=llxrice;Username=postgres;Password=your_password"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

#### ApplicationDbContext.cs

```csharp
using Microsoft.EntityFrameworkCore;
using LLXRice.WebApi.Models.Entities;

namespace LLXRice.WebApi.Data
{
    public class ApplicationDbContext : DbContext
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        public DbSet<Product> Products { get; set; }
        public DbSet<Address> Addresses { get; set; }
        public DbSet<Order> Orders { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<ShippingRate> ShippingRates { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // 配置Product
            modelBuilder.Entity<Product>(entity =>
            {
                entity.Property(e => e.Price).HasPrecision(10, 2);
                entity.Property(e => e.Weight).HasPrecision(10, 2);
            });

            // 配置Order
            modelBuilder.Entity<Order>(entity =>
            {
                entity.Property(e => e.TotalRicePrice).HasPrecision(10, 2);
                entity.Property(e => e.TotalWeight).HasPrecision(10, 2);
                entity.Property(e => e.ShippingRate).HasPrecision(10, 2);
                entity.Property(e => e.TotalShipping).HasPrecision(10, 2);
                entity.Property(e => e.GrandTotal).HasPrecision(10, 2);
                
                entity.HasOne(e => e.Address)
                      .WithMany()
                      .HasForeignKey(e => e.AddressId)
                      .OnDelete(DeleteBehavior.Restrict);
            });

            // 配置OrderItem
            modelBuilder.Entity<OrderItem>(entity =>
            {
                entity.Property(e => e.ProductPrice).HasPrecision(10, 2);
                entity.Property(e => e.ProductWeight).HasPrecision(10, 2);
                entity.Property(e => e.Subtotal).HasPrecision(10, 2);
                
                entity.HasOne(e => e.Order)
                      .WithMany(o => o.Items)
                      .HasForeignKey(e => e.OrderId)
                      .OnDelete(DeleteBehavior.Cascade);
            });

            // 配置ShippingRate
            modelBuilder.Entity<ShippingRate>(entity =>
            {
                entity.Property(e => e.Rate).HasPrecision(10, 2);
                entity.HasIndex(e => e.Province).IsUnique();
            });

            // 初始化运费数据
            modelBuilder.Entity<ShippingRate>().HasData(
                new ShippingRate { Id = 1, Province = "广东省", Rate = 1.5M },
                new ShippingRate { Id = 2, Province = "北京市", Rate = 2.0M },
                new ShippingRate { Id = 3, Province = "上海市", Rate = 2.0M },
                new ShippingRate { Id = 4, Province = "江苏省", Rate = 2.0M },
                new ShippingRate { Id = 5, Province = "浙江省", Rate = 2.0M },
                new ShippingRate { Id = 6, Province = "default", Rate = 2.5M }
            );
        }
    }
}
```

---

## 核心代码实现说明

### 1. 实体模型示例（Product.cs）

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace LLXRice.WebApi.Models.Entities
{
    [Table("Products")]
    public class Product
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [MaxLength(100)]
        public string Name { get; set; }

        [Required]
        [Column(TypeName = "decimal(10,2)")]
        public decimal Price { get; set; }

        [Required]
        [MaxLength(20)]
        public string Unit { get; set; }

        [Required]
        [Column(TypeName = "decimal(10,2)")]
        public decimal Weight { get; set; }

        public string Image { get; set; }

        public int Quantity { get; set; } = 0;

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    }
}
```

### 2. 控制器示例（ProductsController.cs）

```csharp
using Microsoft.AspNetCore.Mvc;
using LLXRice.WebApi.Models.DTOs;
using LLXRice.WebApi.Services.Interfaces;

namespace LLXRice.WebApi.Controllers
{
    [ApiController]
    [Route("api/v1/[controller]")]
    public class ProductsController : ControllerBase
    {
        private readonly IProductService _productService;
        private readonly ILogger<ProductsController> _logger;

        public ProductsController(
            IProductService productService,
            ILogger<ProductsController> logger)
        {
            _productService = productService;
            _logger = logger;
        }

        /// <summary>
        /// 获取所有商品
        /// </summary>
        [HttpGet]
        public async Task<ActionResult<ApiResponse<List<ProductDto>>>> GetAllProducts()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                return Ok(new ApiResponse<List<ProductDto>>
                {
                    Success = true,
                    Message = "获取成功",
                    Data = products,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取商品列表失败");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "服务器内部错误"
                });
            }
        }

        /// <summary>
        /// 根据ID获取商品
        /// </summary>
        [HttpGet("{id}")]
        public async Task<ActionResult<ApiResponse<ProductDto>>> GetProductById(int id)
        {
            try
            {
                var product = await _productService.GetProductByIdAsync(id);
                if (product == null)
                {
                    return NotFound(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "商品不存在"
                    });
                }

                return Ok(new ApiResponse<ProductDto>
                {
                    Success = true,
                    Message = "获取成功",
                    Data = product,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"获取商品失败: {id}");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "服务器内部错误"
                });
            }
        }

        /// <summary>
        /// 创建新商品
        /// </summary>
        [HttpPost]
        public async Task<ActionResult<ApiResponse<ProductDto>>> CreateProduct(
            [FromBody] CreateProductDto dto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "请求参数无效"
                    });
                }

                var product = await _productService.CreateProductAsync(dto);
                return CreatedAtAction(
                    nameof(GetProductById),
                    new { id = product.Id },
                    new ApiResponse<ProductDto>
                    {
                        Success = true,
                        Message = "创建成功",
                        Data = product,
                        Timestamp = DateTime.UtcNow
                    });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "创建商品失败");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "服务器内部错误"
                });
            }
        }

        /// <summary>
        /// 更新商品
        /// </summary>
        [HttpPut("{id}")]
        public async Task<ActionResult<ApiResponse<ProductDto>>> UpdateProduct(
            int id,
            [FromBody] UpdateProductDto dto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "请求参数无效"
                    });
                }

                var product = await _productService.UpdateProductAsync(id, dto);
                if (product == null)
                {
                    return NotFound(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "商品不存在"
                    });
                }

                return Ok(new ApiResponse<ProductDto>
                {
                    Success = true,
                    Message = "更新成功",
                    Data = product,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"更新商品失败: {id}");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "服务器内部错误"
                });
            }
        }

        /// <summary>
        /// 删除商品
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<ActionResult<ApiResponse<object>>> DeleteProduct(int id)
        {
            try
            {
                var success = await _productService.DeleteProductAsync(id);
                if (!success)
                {
                    return NotFound(new ApiResponse<object>
                    {
                        Success = false,
                        Message = "商品不存在"
                    });
                }

                return Ok(new ApiResponse<object>
                {
                    Success = true,
                    Message = "删除成功",
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"删除商品失败: {id}");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "服务器内部错误"
                });
            }
        }
    }
}
```

### 3. 服务层示例（OrderService.cs - 核心逻辑）

```csharp
public class OrderService : IOrderService
{
    private readonly IOrderRepository _orderRepository;
    private readonly IProductRepository _productRepository;
    private readonly IAddressRepository _addressRepository;
    private readonly IShippingService _shippingService;

    public async Task<OrderDto> CreateOrderAsync(CreateOrderDto dto)
    {
        // 1. 验证地址
        var address = await _addressRepository.GetByIdAsync(dto.AddressId);
        if (address == null)
            throw new Exception("收货地址不存在");

        // 2. 验证商品并计算价格
        decimal totalRicePrice = 0;
        decimal totalWeight = 0;
        var orderItems = new List<OrderItem>();

        foreach (var item in dto.Items)
        {
            var product = await _productRepository.GetByIdAsync(item.ProductId);
            if (product == null)
                throw new Exception($"商品不存在: {item.ProductId}");

            var subtotal = product.Price * item.Quantity;
            var itemWeight = product.Weight * item.Quantity;

            totalRicePrice += subtotal;
            totalWeight += itemWeight;

            orderItems.Add(new OrderItem
            {
                ProductId = product.Id,
                ProductName = product.Name,
                ProductPrice = product.Price,
                ProductUnit = product.Unit,
                ProductWeight = product.Weight,
                Quantity = item.Quantity,
                Subtotal = subtotal
            });
        }

        // 3. 计算运费
        var shippingInfo = await _shippingService.CalculateShippingAsync(
            address.Province, totalWeight);

        // 4. 生成订单号
        var orderNo = GenerateOrderNumber();

        // 5. 创建订单
        var order = new Order
        {
            OrderNo = orderNo,
            AddressId = dto.AddressId,
            TotalRicePrice = totalRicePrice,
            TotalWeight = totalWeight,
            ShippingRate = shippingInfo.Rate,
            TotalShipping = shippingInfo.Shipping,
            GrandTotal = totalRicePrice + shippingInfo.Shipping,
            Status = "待发货",
            Items = orderItems
        };

        // 6. 保存订单
        var created = await _orderRepository.CreateAsync(order);
        
        return MapToDto(created);
    }

    private string GenerateOrderNumber()
    {
        return $"ORD{DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}";
    }
}
```

### 4. 地址解析工具（AddressParser.cs）

```csharp
using System.Text.RegularExpressions;

namespace LLXRice.WebApi.Utilities
{
    public class AddressParser
    {
        /// <summary>
        /// 解析地址文本
        /// </summary>
        public static ParsedAddress Parse(string text)
        {
            if (string.IsNullOrWhiteSpace(text))
                return null;

            var result = new ParsedAddress();

            // 清理文本
            var cleanText = Regex.Replace(text, @"\s+", "");

            // 提取姓名（2-4个汉字）
            var nameMatch = Regex.Match(cleanText, @"^[\u4e00-\u9fa5]{2,4}(?![一-龥])");
            if (nameMatch.Success)
            {
                result.Name = nameMatch.Value;
                cleanText = cleanText.Substring(nameMatch.Length);
            }

            // 提取电话（11位手机号）
            var phoneMatch = Regex.Match(cleanText, @"1[3-9]\d{9}");
            if (phoneMatch.Success)
            {
                result.Phone = phoneMatch.Value;
                cleanText = cleanText.Replace(phoneMatch.Value, "");
            }

            // 提取省市区
            var provinceMatch = Regex.Match(cleanText, @"([\u4e00-\u9fa5]{2,10}?(?:省|自治区|特别行政区))");
            if (provinceMatch.Success)
            {
                result.Province = provinceMatch.Value;
                cleanText = cleanText.Replace(provinceMatch.Value, "");
            }

            var cityMatch = Regex.Match(cleanText, @"([\u4e00-\u9fa5]{2,10}?(?:市|地区|州|盟))");
            if (cityMatch.Success)
            {
                result.City = cityMatch.Value;
                cleanText = cleanText.Replace(cityMatch.Value, "");
            }

            var districtMatch = Regex.Match(cleanText, @"([\u4e00-\u9fa5]{2,10}?(?:区|县|市|旗))");
            if (districtMatch.Success)
            {
                result.District = districtMatch.Value;
                cleanText = cleanText.Replace(districtMatch.Value, "");
            }

            // 剩余部分作为详细地址
            result.Detail = cleanText.Trim();

            return result;
        }
    }

    public class ParsedAddress
    {
        public string Name { get; set; }
        public string Phone { get; set; }
        public string Province { get; set; }
        public string City { get; set; }
        public string District { get; set; }
        public string Detail { get; set; }
    }
}
```

---

## 部署方案

### 方案一：Windows Server + IIS 部署

#### 1. 环境准备

```powershell
# 安装 .NET 8 Runtime
# 下载并安装：https://dotnet.microsoft.com/download/dotnet/8.0

# 安装 PostgreSQL 16
# 下载并安装：https://www.postgresql.org/download/windows/

# 安装 IIS
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ASPNET45
```

#### 2. 发布应用

```powershell
# 发布为独立部署
dotnet publish -c Release -o ./publish --self-contained false

# 或发布为自包含部署（包含运行时）
dotnet publish -c Release -o ./publish --self-contained true -r win-x64
```

#### 3. IIS 配置

```xml
<!-- web.config -->
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
    </handlers>
    <aspNetCore processPath="dotnet"
                arguments=".\LLXRice.WebApi.dll"
                stdoutLogEnabled="false"
                stdoutLogFile=".\logs\stdout"
                hostingModel="inprocess" />
  </system.webServer>
</configuration>
```

#### 4. 数据库配置

```sql
-- 在PostgreSQL中创建数据库
CREATE DATABASE llxrice;

-- 创建用户（可选）
CREATE USER llxrice_user WITH PASSWORD 'strong_password';
GRANT ALL PRIVILEGES ON DATABASE llxrice TO llxrice_user;
```

#### 5. 运行迁移

```powershell
# 在发布目录执行
cd ./publish
dotnet LLXRice.WebApi.dll --migrate
# 或手动执行迁移
dotnet ef database update
```

### 方案二：Linux + Docker 部署

#### 1. Dockerfile

```dockerfile
# Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["src/LLXRice.WebApi/LLXRice.WebApi.csproj", "LLXRice.WebApi/"]
RUN dotnet restore "LLXRice.WebApi/LLXRice.WebApi.csproj"

COPY src/ .
WORKDIR "/src/LLXRice.WebApi"
RUN dotnet build "LLXRice.WebApi.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "LLXRice.WebApi.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "LLXRice.WebApi.dll"]
```

#### 2. docker-compose.yml

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: llxrice_db
    environment:
      POSTGRES_DB: llxrice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your_strong_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - llxrice_network

  webapi:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: llxrice_api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=llxrice;Username=postgres;Password=your_strong_password
    ports:
      - "8080:80"
      - "8443:443"
    depends_on:
      - postgres
    networks:
      - llxrice_network

volumes:
  postgres_data:

networks:
  llxrice_network:
    driver: bridge
```

#### 3. 部署命令

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f webapi

# 停止服务
docker-compose down

# 重新构建
docker-compose up -d --build
```

### 方案三：云服务部署（推荐）

#### Azure App Service

```bash
# 安装 Azure CLI
# 登录
az login

# 创建资源组
az group create --name llxrice-rg --location eastasia

# 创建 PostgreSQL 数据库
az postgres flexible-server create \
  --name llxrice-db \
  --resource-group llxrice-rg \
  --location eastasia \
  --admin-user adminuser \
  --admin-password YourPassword123! \
  --sku-name Standard_B1ms

# 创建 App Service
az appservice plan create \
  --name llxrice-plan \
  --resource-group llxrice-rg \
  --sku B1 \
  --is-linux

az webapp create \
  --name llxrice-api \
  --resource-group llxrice-rg \
  --plan llxrice-plan \
  --runtime "DOTNETCORE:8.0"

# 配置连接字符串
az webapp config connection-string set \
  --name llxrice-api \
  --resource-group llxrice-rg \
  --connection-string-type PostgreSQL \
  --settings DefaultConnection="Host=llxrice-db.postgres.database.azure.com;Database=llxrice;Username=adminuser;Password=YourPassword123!"

# 部署应用
az webapp deployment source config-zip \
  --name llxrice-api \
  --resource-group llxrice-rg \
  --src ./publish.zip
```

### 部署检查清单

- [ ] 数据库连接字符串配置正确
- [ ] 数据库迁移已执行
- [ ] CORS策略已配置
- [ ] SSL证书已配置（生产环境）
- [ ] 日志记录已启用
- [ ] 性能监控已配置
- [ ] 备份策略已设置
- [ ] 防火墙规则已配置

---

## 小程序对接说明

### 1. 配置小程序合法域名

在微信公众平台配置服务器域名：
```
request合法域名：https://api.llxrice.com
```

### 2. 小程序HTTP请求封装

创建 `utils/httpClient.js`：

```javascript
// utils/httpClient.js
const BASE_URL = 'https://api.llxrice.com/api/v1'

class HttpClient {
  /**
   * 通用请求方法
   */
  static request(url, method = 'GET', data = null) {
    return new Promise((resolve, reject) => {
      wx.showLoading({
        title: '加载中...',
        mask: true
      })

      wx.request({
        url: `${BASE_URL}${url}`,
        method: method,
        data: data,
        header: {
          'Content-Type': 'application/json'
        },
        success: (res) => {
          wx.hideLoading()
          
          if (res.statusCode === 200 && res.data.success) {
            resolve(res.data.data)
          } else {
            wx.showToast({
              title: res.data.message || '请求失败',
              icon: 'none'
            })
            reject(res.data)
          }
        },
        fail: (err) => {
          wx.hideLoading()
          wx.showToast({
            title: '网络请求失败',
            icon: 'none'
          })
          reject(err)
        }
      })
    })
  }

  // GET请求
  static get(url) {
    return this.request(url, 'GET')
  }

  // POST请求
  static post(url, data) {
    return this.request(url, 'POST', data)
  }

  // PUT请求
  static put(url, data) {
    return this.request(url, 'PUT', data)
  }

  // DELETE请求
  static delete(url) {
    return this.request(url, 'DELETE')
  }
}

module.exports = HttpClient
```

### 3. API服务封装

创建 `utils/apiService.js`：

```javascript
// utils/apiService.js
const HttpClient = require('./httpClient.js')

class ApiService {
  // ========== 商品相关 ==========
  
  /**
   * 获取商品列表
   */
  static getProducts() {
    return HttpClient.get('/products')
  }

  /**
   * 获取单个商品
   */
  static getProductById(id) {
    return HttpClient.get(`/products/${id}`)
  }

  /**
   * 创建商品
   */
  static createProduct(data) {
    return HttpClient.post('/products', data)
  }

  /**
   * 更新商品
   */
  static updateProduct(id, data) {
    return HttpClient.put(`/products/${id}`, data)
  }

  /**
   * 删除商品
   */
  static deleteProduct(id) {
    return HttpClient.delete(`/products/${id}`)
  }

  // ========== 地址相关 ==========
  
  /**
   * 获取地址列表
   */
  static getAddresses() {
    return HttpClient.get('/addresses')
  }

  /**
   * 创建地址
   */
  static createAddress(data) {
    return HttpClient.post('/addresses', data)
  }

  /**
   * 更新地址
   */
  static updateAddress(id, data) {
    return HttpClient.put(`/addresses/${id}`, data)
  }

  /**
   * 删除地址
   */
  static deleteAddress(id) {
    return HttpClient.delete(`/addresses/${id}`)
  }

  /**
   * 设置默认地址
   */
  static setDefaultAddress(id) {
    return HttpClient.put(`/addresses/${id}/set-default`)
  }

  /**
   * 解析地址文本
   */
  static parseAddress(text) {
    return HttpClient.post('/addresses/parse', { text })
  }

  // ========== 订单相关 ==========
  
  /**
   * 获取订单列表
   */
  static getOrders(page = 1, pageSize = 10, status = null) {
    let url = `/orders?page=${page}&pageSize=${pageSize}`
    if (status) {
      url += `&status=${status}`
    }
    return HttpClient.get(url)
  }

  /**
   * 获取订单详情
   */
  static getOrderById(id) {
    return HttpClient.get(`/orders/${id}`)
  }

  /**
   * 创建订单
   */
  static createOrder(data) {
    return HttpClient.post('/orders', data)
  }

  /**
   * 更新订单状态
   */
  static updateOrderStatus(id, status) {
    return HttpClient.put(`/orders/${id}/status`, { status })
  }

  /**
   * 删除订单
   */
  static deleteOrder(id) {
    return HttpClient.delete(`/orders/${id}`)
  }

  // ========== 运费相关 ==========
  
  /**
   * 计算运费
   */
  static calculateShipping(province, weight) {
    return HttpClient.post('/shipping/calculate', { province, weight })
  }

  /**
   * 获取运费配置
   */
  static getShippingRates() {
    return HttpClient.get('/shipping/rates')
  }
}

module.exports = ApiService
```

### 4. 小程序页面改造示例

#### 4.1 修改 index.js（商品页面）

```javascript
// pages/index/index.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    riceProducts: [],
    // ... 其他数据
  },

  onLoad() {
    // 从API加载商品数据
    this.loadProducts()
  },

  /**
   * 从API加载商品列表
   */
  async loadProducts() {
    try {
      const products = await ApiService.getProducts()
      this.setData({
        riceProducts: products,
        isEmpty: products.length === 0
      })
      console.log('成功从API加载商品数据', products.length, '个商品')
    } catch (error) {
      console.error('加载商品失败', error)
      // 降级到本地存储
      this.loadLocalData()
    }
  },

  /**
   * 添加新商品（保存到API）
   */
  async confirmAddRice() {
    const { newRiceName, newRicePrice, newRiceUnit, newRiceWeight, newRiceImage } = this.data

    // 验证输入...

    try {
      const newProduct = {
        name: newRiceName.trim(),
        price: parseFloat(newRicePrice),
        unit: newRiceUnit,
        weight: parseFloat(newRiceWeight),
        image: newRiceImage,
        quantity: 0
      }

      // 调用API创建商品
      const created = await ApiService.createProduct(newProduct)
      
      // 重新加载商品列表
      await this.loadProducts()

      this.setData({
        showAddDialog: false
      })

      wx.showToast({
        title: '添加成功',
        icon: 'success'
      })
    } catch (error) {
      console.error('添加商品失败', error)
      wx.showToast({
        title: '添加失败',
        icon: 'none'
      })
    }
  },

  /**
   * 删除商品（从API删除）
   */
  async deleteProduct(e) {
    const { id } = e.currentTarget.dataset
    
    wx.showModal({
      title: '确认删除',
      content: '确定要删除这个大米类型吗？',
      success: async (res) => {
        if (res.confirm) {
          try {
            await ApiService.deleteProduct(id)
            await this.loadProducts()
            
            wx.showToast({
              title: '删除成功',
              icon: 'success'
            })
          } catch (error) {
            console.error('删除商品失败', error)
            wx.showToast({
              title: '删除失败',
              icon: 'none'
            })
          }
        }
      }
    })
  }
})
```

#### 4.2 修改 checkout.js（结算页面）

```javascript
// pages/checkout/checkout.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    selectedProducts: [],
    selectedAddress: null,
    // ... 其他数据
  },

  /**
   * 确认下单（调用API）
   */
  async confirmOrder() {
    const { selectedAddress, selectedProducts } = this.data

    if (!selectedAddress) {
      wx.showToast({
        title: '请先选择收货地址',
        icon: 'none'
      })
      return
    }

    try {
      // 准备订单数据
      const orderData = {
        addressId: selectedAddress.id,
        items: selectedProducts.map(p => ({
          productId: p.id,
          quantity: p.quantity
        }))
      }

      // 调用API创建订单
      const order = await ApiService.createOrder(orderData)

      wx.showToast({
        title: '下单成功！',
        icon: 'success',
        duration: 1500
      })

      // 下单成功后的处理...
      setTimeout(() => {
        wx.reLaunch({
          url: '/pages/index/index'
        })
      }, 1500)
    } catch (error) {
      console.error('创建订单失败', error)
      wx.showToast({
        title: '下单失败，请重试',
        icon: 'none'
      })
    }
  }
})
```

#### 4.3 修改 orders.js（订单页面）

```javascript
// pages/orders/orders.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    orderList: [],
    page: 1,
    pageSize: 10,
    total: 0
  },

  onShow() {
    this.loadOrders()
  },

  /**
   * 从API加载订单列表
   */
  async loadOrders() {
    try {
      const result = await ApiService.getOrders(this.data.page, this.data.pageSize)
      this.setData({
        orderList: result.items,
        total: result.total
      })
      console.log('加载订单', result.items.length, '个')
    } catch (error) {
      console.error('加载订单失败', error)
      // 降级到本地存储
      this.loadLocalOrders()
    }
  },

  /**
   * 删除订单（从API删除）
   */
  async deleteOrder(e) {
    const { orderid } = e.currentTarget.dataset
    
    wx.showModal({
      title: '确认删除',
      content: '确定要删除这个订单吗？',
      success: async (res) => {
        if (res.confirm) {
          try {
            await ApiService.deleteOrder(orderid)
            await this.loadOrders()
            
            wx.showToast({
              title: '删除成功',
              icon: 'success'
            })
          } catch (error) {
            console.error('删除订单失败', error)
            wx.showToast({
              title: '删除失败',
              icon: 'none'
            })
          }
        }
      }
    })
  }
})
```

#### 4.4 修改 address.js（地址页面）

```javascript
// pages/address/address.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    addressList: [],
    // ... 其他数据
  },

  onLoad(options) {
    this.loadAddressList()
  },

  /**
   * 从API加载地址列表
   */
  async loadAddressList() {
    try {
      const addresses = await ApiService.getAddresses()
      this.setData({
        addressList: addresses
      })
      console.log('加载地址列表', addresses.length, '个地址')
    } catch (error) {
      console.error('加载地址列表失败', error)
      // 降级到本地存储
      this.loadLocalAddresses()
    }
  },

  /**
   * 智能识别地址（调用API）
   */
  async parseAddressText() {
    const { pasteText } = this.data
    
    if (!pasteText.trim()) {
      wx.showToast({
        title: '请输入地址信息',
        icon: 'none'
      })
      return
    }

    try {
      const result = await ApiService.parseAddress(pasteText)
      
      // 填充表单
      this.setData({
        formName: result.name || '',
        formPhone: result.phone || '',
        formProvince: result.province || '',
        formCity: result.city || '',
        formDistrict: result.district || '',
        formDetail: result.detail || '',
        showPasteDialog: false
      })

      wx.showToast({
        title: '识别成功',
        icon: 'success'
      })
    } catch (error) {
      console.error('地址识别失败', error)
      wx.showToast({
        title: '识别失败，请手动输入',
        icon: 'none'
      })
    }
  },

  /**
   * 保存地址（到API）
   */
  async saveAddress() {
    const {
      formName, formPhone, formProvince, formCity,
      formDistrict, formDetail, formIsDefault,
      editingAddress
    } = this.data

    // 验证输入...

    try {
      const addressData = {
        name: formName.trim(),
        phone: formPhone.trim(),
        province: formProvince.trim(),
        city: formCity.trim(),
        district: formDistrict.trim(),
        detail: formDetail.trim(),
        isDefault: formIsDefault
      }

      if (editingAddress) {
        // 更新地址
        await ApiService.updateAddress(editingAddress.id, addressData)
      } else {
        // 创建地址
        await ApiService.createAddress(addressData)
      }

      await this.loadAddressList()

      this.setData({
        showEditDialog: false
      })

      wx.showToast({
        title: editingAddress ? '修改成功' : '添加成功',
        icon: 'success'
      })
    } catch (error) {
      console.error('保存地址失败', error)
      wx.showToast({
        title: '保存失败',
        icon: 'none'
      })
    }
  },

  /**
   * 删除地址（从API删除）
   */
  async deleteAddress(e) {
    const { id } = e.currentTarget.dataset
    
    wx.showModal({
      title: '确认删除',
      content: '确定要删除这个地址吗？',
      success: async (res) => {
        if (res.confirm) {
          try {
            await ApiService.deleteAddress(id)
            await this.loadAddressList()
            
            wx.showToast({
              title: '删除成功',
              icon: 'success'
            })
          } catch (error) {
            console.error('删除地址失败', error)
            wx.showToast({
              title: '删除失败',
              icon: 'none'
            })
          }
        }
      }
    })
  }
})
```

### 5. 数据同步策略

#### 离线优先策略

```javascript
// utils/syncManager.js
class SyncManager {
  /**
   * 加载数据（优先API，降级本地）
   */
  static async loadData(apiMethod, localStorageKey) {
    try {
      // 尝试从API加载
      const data = await apiMethod()
      // 缓存到本地
      wx.setStorageSync(localStorageKey, data)
      return data
    } catch (error) {
      console.error('API加载失败，使用本地缓存', error)
      // 降级到本地存储
      return wx.getStorageSync(localStorageKey) || []
    }
  }

  /**
   * 保存数据（优先API，降级本地）
   */
  static async saveData(apiMethod, localStorageKey, data) {
    try {
      // 尝试保存到API
      const result = await apiMethod(data)
      // 同步到本地
      const localData = wx.getStorageSync(localStorageKey) || []
      localData.push(result)
      wx.setStorageSync(localStorageKey, localData)
      return result
    } catch (error) {
      console.error('API保存失败，仅保存到本地', error)
      // 降级到本地存储
      const localData = wx.getStorageSync(localStorageKey) || []
      localData.push(data)
      wx.setStorageSync(localStorageKey, localData)
      throw error
    }
  }
}

module.exports = SyncManager
```

---

## 开发步骤

### 阶段一：项目初始化（第1-2天）

1. **创建项目**
   ```bash
   dotnet new webapi -n LLXRice.WebApi
   cd LLXRice.WebApi
   ```

2. **安装依赖包**
   ```bash
   dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL
   dotnet add package Microsoft.EntityFrameworkCore.Tools
   dotnet add package Microsoft.EntityFrameworkCore.Design
   dotnet add package Swashbuckle.AspNetCore
   dotnet add package AutoMapper.Extensions.Microsoft.DependencyInjection
   ```

3. **配置数据库连接**
   - 修改 `appsettings.json`
   - 创建 `ApplicationDbContext`

4. **创建实体模型**
   - Product, Address, Order, OrderItem, ShippingRate

### 阶段二：数据访问层（第3-4天）

1. **创建仓储接口**
   - IProductRepository
   - IAddressRepository
   - IOrderRepository
   - IShippingRateRepository

2. **实现仓储类**
   - 实现CRUD操作
   - 添加查询方法

3. **数据库迁移**
   ```bash
   dotnet ef migrations add InitialCreate
   dotnet ef database update
   ```

### 阶段三：业务逻辑层（第5-6天）

1. **创建服务接口**
   - IProductService
   - IAddressService
   - IOrderService
   - IShippingService

2. **实现服务类**
   - 实现业务逻辑
   - 添加数据验证
   - 实现地址解析

### 阶段四：API控制器（第7-8天）

1. **创建控制器**
   - ProductsController
   - AddressesController
   - OrdersController
   - ShippingController

2. **配置Swagger**
   - 添加API文档注释
   - 配置请求/响应示例

3. **测试API**
   - 使用Postman测试所有接口

### 阶段五：小程序对接（第9-10天）

1. **创建HTTP客户端**
   - httpClient.js
   - apiService.js

2. **改造小程序页面**
   - index.js
   - checkout.js
   - orders.js
   - address.js

3. **测试对接**
   - 测试所有功能
   - 验证数据同步

### 阶段六：部署上线（第11-12天）

1. **准备生产环境**
   - 配置服务器
   - 安装PostgreSQL
   - 配置SSL证书

2. **部署应用**
   - 发布应用
   - 配置IIS/Docker
   - 运行数据库迁移

3. **配置小程序**
   - 配置服务器域名
   - 提交审核

4. **测试验证**
   - 功能测试
   - 性能测试
   - 压力测试

---

## 附录

### A. NuGet包清单

```xml
<ItemGroup>
  <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.0" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0" />
  <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.0" />
  <PackageReference Include="AutoMapper.Extensions.Microsoft.DependencyInjection" Version="12.0.0" />
  <PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
  <PackageReference Include="Serilog.AspNetCore" Version="8.0.0" />
</ItemGroup>
```

### B. 常用EF Core命令

```bash
# 创建迁移
dotnet ef migrations add MigrationName

# 应用迁移
dotnet ef database update

# 回滚迁移
dotnet ef database update PreviousMigrationName

# 删除迁移
dotnet ef migrations remove

# 生成SQL脚本
dotnet ef migrations script

# 查看迁移列表
dotnet ef migrations list
```

### C. PostgreSQL常用命令

```sql
-- 查看所有数据库
\l

-- 连接数据库
\c llxrice

-- 查看所有表
\dt

-- 查看表结构
\d "Products"

-- 查看表数据
SELECT * FROM "Products";

-- 备份数据库
pg_dump llxrice > backup.sql

-- 恢复数据库
psql llxrice < backup.sql
```

### D. 开发工具推荐

- **IDE**: Visual Studio 2022 / VS Code
- **数据库工具**: pgAdmin 4 / DBeaver
- **API测试**: Postman / Swagger UI
- **版本控制**: Git / GitHub
- **容器化**: Docker Desktop
- **日志查看**: Seq / ELK Stack

---

## 总结

本设计方案提供了一个完整的后端服务架构，包括：

✅ **数据库设计**：PostgreSQL数据库表结构设计完整
✅ **API设计**：RESTful API接口设计规范
✅ **技术实现**：.NET 8 Web API + EF Core + PostgreSQL
✅ **部署方案**：提供Windows/Linux/Docker/云服务多种部署方案
✅ **小程序对接**：详细的对接方案和代码示例
✅ **开发步骤**：清晰的12天开发计划

该方案可以直接用于项目开发，所有接口都已设计完整，数据库结构清晰，部署方案可行。

---

**文档版本**：v1.0  
**创建日期**：2025年10月16日  
**适用版本**：.NET 8 + PostgreSQL 16  
**维护状态**：✅ 完整设计方案

---

© 2025 林龍香大米商城后端服务设计方案

