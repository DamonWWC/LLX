# WXML 编译错误修复说明

## 问题描述

编译时出现错误：
```
WXML 文件编译错误] ./pages/index/index.wxml 
Bad value with message: unexpected token `.`
```

## 错误原因

在 WXML 文件的第 69 行使用了 `.toFixed(2)` 方法：
```xml
<view class="item-price">¥{{(item.price * item.quantity).toFixed(2)}}</view>
```

**问题**：微信小程序的 WXML 模板语法中，`{{}}` 表达式不支持调用对象方法（如 `.toFixed()`、`.map()` 等）。

## 解决方案

### 修改方式

将数据计算逻辑从 WXML 移到 JavaScript 中：

#### 1. 在 JS 中预先计算数据

**修改前**：
- WXML 中直接计算：`{{(item.price * item.quantity).toFixed(2)}}`

**修改后**：
- JS 中计算好：
```javascript
const selectedProducts = []
riceProducts.forEach(product => {
  if (product.quantity > 0) {
    const subtotal = (product.price * product.quantity + product.shipping * product.quantity).toFixed(2)
    selectedProducts.push({
      id: product.id,
      name: product.name,
      quantity: product.quantity,
      subtotal: subtotal
    })
  }
})
```

- WXML 中直接使用：`{{item.subtotal}}`

#### 2. 添加 isEmpty 状态变量

**修改前**：
```xml
wx:if="{{riceProducts.length === 0}}"
```

**修改后**：
- JS 中添加状态变量：`isEmpty: false`
- 更新时同步修改
- WXML 中使用：`wx:if="{{isEmpty}}"`

### 具体修改内容

#### index.js 修改
1. 添加 `selectedProducts` 数组存储已选商品（含小计）
2. 添加 `isEmpty` 布尔值判断空状态
3. 在 `goCheckout()` 函数中预计算所有数据
4. 在添加/删除商品时同步更新 `isEmpty` 状态

#### index.wxml 修改
1. 将 `wx:for="{{riceProducts}}"` 改为 `wx:for="{{selectedProducts}}"`（结算区域）
2. 将 `{{(item.price * item.quantity).toFixed(2)}}` 改为 `{{item.subtotal}}`
3. 将 `wx:if="{{riceProducts.length === 0}}"` 改为 `wx:if="{{isEmpty}}"`

## WXML 语法限制

在微信小程序的 WXML 中，`{{}}` 表达式支持：
- ✅ 变量访问：`{{name}}`
- ✅ 属性访问：`{{item.name}}`
- ✅ 简单运算：`{{a + b}}`、`{{a > b}}`
- ✅ 三元运算：`{{a ? b : c}}`

但**不支持**：
- ❌ 方法调用：`{{value.toFixed(2)}}`
- ❌ 数组方法：`{{arr.map(...)}}、{{arr.filter(...)}}`
- ❌ 复杂表达式：`{{arr.find(x => x.id === id)}}`

## 最佳实践

1. **数据计算放在 JS 中**：复杂计算、格式化、过滤等都应在 JS 中完成
2. **WXML 只做展示**：模板中只负责显示已经处理好的数据
3. **使用计算属性**：预先计算好需要在模板中使用的所有数据
4. **保持简洁**：WXML 表达式越简单越好

## 修复结果

✅ 编译通过，无错误
✅ 功能正常，显示正确
✅ 代码更清晰，维护性更好

## 测试建议

1. 点击"添加品种"添加新商品
2. 使用 +/- 按钮调整数量
3. 点击"去结算"查看结算详情
4. 验证小计金额显示正确（保留两位小数）
5. 点击"保存为图片"测试图片生成

修复时间：2025-10-15

